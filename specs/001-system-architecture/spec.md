# Feature Specification: 司機員管理系統整體架構

**Feature Branch**: `001-system-architecture`
**Created**: 2026-01-28
**Status**: Draft
**Priority**: P0 (Foundation)

## Executive Summary

建立新北捷運輕軌營運處車務中心「司機員事件履歷與考核管理、駕駛時數管理系統」，支援淡海分處與安坑分處雙部門架構，整合 Google Sheets 班表/勤務表資料、Google Drive 文件管理、駕駛競賽排名計算。

**系統架構**（混合式三層架構）：
- **前端**：GitHub Pages 託管的網頁應用（Vue.js/React），作為主要使用者介面
- **雲端後端**：Render 部署的 FastAPI 服務 + TiDB MySQL 資料庫
- **本機應用**：桌面應用程式提供本機 API（localhost:8000），負責檔案操作（Word生成、PDF掃描、條碼生成、Google Drive上傳）

**容錯設計**：核心功能（資料瀏覽、履歷建立、員工管理、報表查詢）完全運行於網頁端，即使桌面應用程式發生錯誤或未啟動，仍可正常使用系統的基本功能。檔案生成功能在桌面應用不可用時，會給予明確提示。

---

## Glossary ⭐ **(新增：術語表)**

本章節定義專案中使用的關鍵術語，確保團隊溝通一致性。

### 憑證與認證

| 術語 | 定義 | 用途 | 範例 |
|------|------|------|------|
| **Service Account** | Google 服務帳戶憑證，用於伺服器端應用程式 | 讀取 Google Sheets（班表、勤務表） | `alarm-kunpeto@lateral-shore-461508-m0.iam.gserviceaccount.com` |
| **OAuth 2.0 憑證** | Google OAuth 2.0 客戶端憑證，用於使用者授權流程 | 使用者授權後上傳檔案到 Google Drive | `client_id`, `client_secret`, `redirect_uris` |
| **Refresh Token** | OAuth 2.0 長期有效令牌，用於自動更新 Access Token | 本機/雲端儲存，用於自動化上傳 | 有效期：無限期（直到使用者撤銷） |
| **Access Token** | OAuth 2.0 短期有效令牌，用於實際 API 請求 | 由 Refresh Token 換取，每次請求使用 | 有效期：1 小時 |

### 系統架構

| 術語 | 標準名稱 | 別名（避免使用） | 定義 |
|------|---------|----------------|------|
| **GitHub Pages** | GitHub Pages | 前端網頁、靜態網站 | 託管於 GitHub Pages 的 Vue.js 前端應用 |
| **雲端 API** | Render FastAPI | 雲端後端、Render 後端 | 部署於 Render 的 FastAPI 後端服務（包含資料 CRUD、認證、Google Sheets 同步） |
| **本機 API** | 本機桌面應用 API | 桌面應用、本機後端 | 執行於 localhost:8000 的 FastAPI 服務（檔案處理：Word、PDF、條碼、Drive 上傳） |
| **TiDB** | TiDB MySQL | 雲端資料庫、MySQL 資料庫 | TiDB Serverless（MySQL 8.0 相容）共享資料庫 |

### Google 服務

| 術語 | 定義 | 資料範例 |
|------|------|---------|
| **Google Sheets 班表** | 115年度_班表暨每月R出需求&加班工時總表 | Sheet ID: `15Y6H2GKFJQUUJvHkoBCmT4fW4HxET9qJWZi4sX08pCQ` |
| **Google Sheets 勤務表** | (目前使用中)202601_勤務表 | Sheet ID: `1HKGd2LzS8p93UvGiOfcePw4Tn_JoJyLbkQKCLtfnnE4` |
| **Google Drive 資料夾** | 淡海/安坑的文件儲存資料夾 | Folder ID: `1NhgiXcYQ5NTRQzmHgLSLqU8M8Ysf3-18`（淡海） |
| **R班** | 休息日出勤，駕駛競賽時數 × 2 | 從班表的「班別」欄位判定 |

### 部門與角色

| 術語 | 定義 | 值域 |
|------|------|------|
| **部門** | 新北捷運輕軌營運處車務中心的分處 | `淡海`、`安坑`（硬編碼，不可新增刪除） |
| **Admin（管理員）** | 系統管理人員，擁有所有權限 | 全部功能 + 後台參數管理 + 雙部門完整權限 |
| **Staff（值班台人員）** | 各分處值班台人員，負責資料維護 | 本部門資料 CRUD + 他部門資料唯讀 |
| **Manager（主管）** | 主管角色，僅查詢與報表產出 | 所有部門資料唯讀 + 報表產出 |

### 資料模型

| 術語 | 定義 | 說明 |
|------|------|------|
| **員工編號** | 員工唯一識別碼 | 格式：YYMMX0XXX（如 1011M0095 = 2021年11月入職） |
| **履歷** | 員工事件記錄（S類安全責任、R類維護責任） | `profiles` 資料表 |
| **調動記錄** | 員工部門調動歷史 | `employee_transfers` 資料表 |
| **駕駛時數** | 每日駕駛分鐘數統計 | `driving_daily_stats` 資料表 |
| **駕駛競賽** | 月度駕駛積分排名 | `driving_competition` 資料表 |
| **勤務標準時間** | 各勤務路線的標準駕駛時間（分鐘） | `route_standard_times` 資料表 |

### 技術術語

| 術語 | 定義 | 技術細節 |
|------|------|---------|
| **Fernet 加密** | 對稱加密演算法，用於加密敏感資料 | `cryptography.fernet`，金鑰長度 44 字元（Base64） |
| **Base64 編碼** | 二進制資料編碼為可儲存文字 | 用於 Service Account JSON 儲存於環境變數 |
| **bcrypt** | 密碼雜湊演算法 | 成本因子最低 12，用於使用者密碼 |
| **JWT (JSON Web Token)** | 使用者認證令牌 | payload 包含 `user_id`, `role`, `department`, `exp` (過期時間), `iat` (發行時間)，有效期限 24 小時 |
| **CORS (Cross-Origin Resource Sharing)** | 跨域資源共享 | GitHub Pages → Render API / localhost API |

---

## Technical Architecture ⭐ **(新增：架構說明)**

### 系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         使用者（瀏覽器）                              │
│                   Chrome / Edge / Firefox                        │
└──────────────┬────────────────────────────┬─────────────────────┘
               │                            │
               │ HTTPS                      │ HTTP (localhost)
               │                            │
               ▼                            ▼
┌─────────────────────────────┐  ┌──────────────────────────────┐
│  GitHub Pages (前端)          │  │  本機桌面應用 API             │
│  - Vue.js / React            │  │  - FastAPI (localhost:8000) │
│  - 靜態網頁託管               │  │  - Word / PDF / 條碼生成     │
│  - 主要使用者介面             │  │  - Google Drive 上傳         │
└──────────────┬──────────────┘  └──────────────┬───────────────┘
               │                                │
               │ HTTPS                          │
               │ (跨域請求)                      │ Google Drive API
               │                                │
               ▼                                ▼
┌─────────────────────────────┐  ┌──────────────────────────────┐
│  Render 雲端 FastAPI          │  │  Google Drive                │
│  - RESTful API               │  │  - 文件儲存                   │
│  - 使用者認證 (JWT)           │  └──────────────────────────────┘
│  - 資料 CRUD                 │
│  - 定時任務 (APScheduler)     │
└──────────────┬──────────────┘
               │
               │ MySQL Protocol (SSL/TLS)
               │
               ▼
┌─────────────────────────────┐
│  TiDB Serverless (資料庫)    │
│  - MySQL 8.0 相容             │
│  - 5GB 儲存空間               │
│  - 員工、履歷、駕駛時數資料    │
└─────────────────────────────┘
```

### 三層架構職責劃分

#### Layer 1: 前端網頁應用（GitHub Pages）
**技術堆疊**：Vue.js 3 / React + Axios + Element Plus / Ant Design

**職責**：
- ✅ 主要使用者介面（資料列表、表單、報表）
- ✅ 使用者互動處理（點擊、輸入、導航）
- ✅ 狀態管理（Pinia / Redux）
- ✅ 路由管理（Vue Router / React Router）
- ✅ 與雲端 API 通訊（資料 CRUD）
- ✅ 檢測本機桌面應用 API 可用性
- ✅ 容錯設計：桌面應用不可用時禁用檔案功能按鈕

**關鍵特性**：
- 無需安裝，開啟瀏覽器即可使用
- 跨平台支援（Windows / macOS / Linux）
- 自動部署（push 到 GitHub 即更新）

---

#### Layer 2: 雲端後端 API（Render FastAPI）
**技術堆疊**：FastAPI + SQLAlchemy + TiDB + APScheduler

**職責**：
- ✅ 資料庫 CRUD 操作（員工、履歷、駕駛時數）
- ✅ 使用者認證與授權（JWT Token）
- ✅ 權限控制中間件（Admin / Staff / Manager）
- ✅ Google Sheets 同步（班表、勤務表）
- ✅ 駕駛競賽排名計算
- ✅ 定時任務管理（APScheduler）
- ✅ 資料庫備份與監控

**關鍵特性**：
- 24/7 運行（UptimeRobot 保持喚醒）
- RESTful API 設計
- 完整錯誤處理與日誌記錄

---

#### Layer 3: 本機桌面應用 API（FastAPI localhost）
**技術堆疊**：FastAPI + python-docx + PyPDF2 + python-barcode + Google Drive API

**職責**：
- ✅ Word 文件生成（履歷報告、通知書）
- ✅ PDF 掃描與條碼識別（部門判斷）
- ✅ 條碼生成（TH/AK 前綴）
- ✅ Google Drive 檔案上傳
- ❌ 不負責資料庫操作（僅檔案處理）

**關鍵特性**：
- 僅在需要檔案操作時啟動
- CORS 設定允許 GitHub Pages 跨域請求
- 系統托盤常駐（啟動/停止 API）
- 失敗不影響核心功能

---

### 資料流向範例

#### 情境 1：使用者新增員工資料（核心功能）
```
使用者 → 前端網頁（填寫表單）
     → 雲端 API（POST /api/employees）
     → TiDB 資料庫（INSERT）
     → 回傳成功
     → 前端顯示成功訊息
```
**無需桌面應用參與** ✅

---

#### 情境 2：使用者生成履歷 Word 文件（檔案功能）
```
使用者 → 前端網頁（點擊「生成 Word」按鈕）
     → 檢測本機 API（localhost:8000/health）
     → 若本機 API 不可用：顯示「請啟動桌面應用程式」❌
     → 若本機 API 可用：
         → 本機 API（POST /api/generate-word）
         → 生成 Word 檔案
         → 回傳下載連結
         → 前端觸發下載
```
**需要桌面應用，但失敗不影響其他功能** ✅

---

### 容錯設計說明

| 情境 | 桌面應用狀態 | 核心功能 | 檔案功能 | 使用者體驗 |
|------|-------------|---------|---------|-----------|
| 正常運行 | ✅ 運行中 | ✅ 可用 | ✅ 可用 | 完整功能 |
| 桌面應用未啟動 | ❌ 未執行 | ✅ 可用 | ❌ 禁用 | 提示「請啟動桌面應用」 |
| 桌面應用錯誤 | ❌ 執行異常 | ✅ 可用 | ❌ 禁用 | 提示「桌面應用發生錯誤」 |
| 網路中斷 | N/A | ❌ 不可用 | ❌ 不可用 | 提示「無法連接伺服器」 |

**設計原則**：核心功能（資料瀏覽、履歷建立、員工管理）完全獨立於桌面應用，即使桌面應用故障，使用者仍可正常使用系統的 80% 功能。

---

## Pending Clarifications

### 🔴 HIGH PRIORITY - 需立即釐清

#### ~~PC-001: 駕駛競賽計算公式~~ ✅ **(已釐清 2026-01-28)** ⭐ **(季度制更新 2026-01-29)**

**決策結果**：駕駛競賽計算公式已確認，並更新為季度制規則

**完整計算公式**（每季結算）：
```
最終積分 = (Σ 每日實際駕駛時數 × R班係數) / (1 + 責任事件次數)

其中：
- 每日實際駕駛時數 = Σ(當日各項勤務的標準分鐘數)
  ├─ 勤務標準時間由後台設定（route_standard_times 資料表）
  └─ 從 Google Sheets 勤務表讀取當日勤務項目

- R班係數：
  ├─ 當日為 R班出勤（休息日出勤）：× 2
  └─ 一般出勤：× 1

- 責任事件懲罰：/ (1 + N)
  ├─ N = 0（當季無責任事件）：/ 1
  ├─ N = 1（當季 1 件責任事件）：/ 2
  ├─ N = 2（當季 2 件責任事件）：/ 3
  └─ N ≥ 3：/ (1 + N) 依此類推
  ├─ 責任事件定義：S類別（行車運轉）+ R類別（故障排除）扣分項目
  └─ 資料來源：profiles 表（待 US8 整合）

- 資格門檻（新增）：
  ├─ 季度累計時數 ≥ 300小時（平均每月100小時）
  └─ 季度最後一日仍在職（is_resigned = false）
```

**排名規則** ⭐ **(季度制更新 2026-01-29)**：
- **評比週期**：每季結算（Q1: 1-3月、Q2: 4-6月、Q3: 7-9月、Q4: 10-12月）
- **計算時機**：每季首日（1/1, 4/1, 7/1, 10/1）凌晨 3:00
- **主要排序**：積分由高到低（積分最高者為第一名）
- **積分相同處理**：並列排名（如兩人並列第 2 名）
  - 下一名的排名跳號（並列第 2 名後，下一名為第 4 名）
  - 報表顯示格式：僅顯示排名數字（如「2」），不額外標註並列
  - 次要排序（積分相同時）：按員工編號升序（資料呈現穩定性）
- **排名名額與獎金**：
  - 淡海分部：前5名（3600/3000/2400/1800/1200 元）
  - 安坑分部：前3名（3600/3000/2400 元）
  - 排名超出名額或不符合資格者：bonus_amount = 0
- **排名範例**：
  | 排名 | 姓名 | 積分 | 時數 | 資格 | 獎金 |
  |------|------|------|------|------|------|
  | 1    | 張三 | 1250 | 320h | ✓    | 3600 |
  | 2    | 李四 | 1100 | 310h | ✓    | 3000 |
  | 3    | 王五 | 980  | 290h | ✗    | 0    |
  | 4    | 趙六 | 950  | 305h | ✓    | 1800 |
- **資格檢查**：
  - 季度累計時數 ≥ 300小時
  - 季度最後一日仍在職
  - 不符合資格者仍有排名但無獎金

**責任事件判定**：
- 統計 S類別（行車運轉）+ R類別（故障排除）扣分項目
- 與 User Story 8（履歷系統）整合

**參考文件**：`C:\Users\kunpe\claude專案\115年度駕駛時數簽文製作\115年度當責駕駛時數激勵方案_最終版.docx`

#### PC-002: 安坑班表結構
**問題**：安坑分處的 Google Sheets 班表結構是否與淡海相同
- 欄位順序是否一致？
- 班別代碼是否一致？
- 分頁命名規則是否一致？

**影響範圍**：班表同步模組
**備選方案**：先實作淡海（使用前專案邏輯），安坑暫時手動輸入
**預計釐清**：Phase 3 安坑模組實作前

### 🟡 MEDIUM PRIORITY - 可延後釐清

#### PC-003: 勤務表詳細結構
**問題**：Google Sheets 勤務表的欄位定義
- 包含哪些欄位？（員工編號、日期、班別、駕駛時數、...？）
- 如何計算每日駕駛分鐘數？
- 責任事件數是否在勤務表中？還是從考核資料庫計算？

**影響範圍**：駕駛時數同步模組
**備選方案**：根據淡海現有資料反推結構
**預計釐清**：Phase 2 駕駛時數模組實作時

#### PC-004: 報表需求細節
**問題**：主管角色需要哪些具體報表
- 考核統計報表（格式？欄位？）
- 駕駛時數統計（日報？月報？年報？）
- 駕駛競賽排名報表（格式？）
- 其他自訂報表？

**影響範圍**：報表模組
**備選方案**：先實作前專案已有的報表，再根據需求擴充
**預計釐清**：Phase 4 報表模組實作時

#### ~~PC-005: 歷史資料遷移需求~~ ✅ **(已釐清 2026-01-28)**
**決策結果**：採用方案 A（完整遷移 2026 年前資料，預設淡海部門）

**資料量分析**：
- 需遷移履歷資料：580 筆（2023-2025 年）
- 員工資料：58 位
- 總資料量：約 1.4 MB（佔 TiDB 5GB 的 0.03%）

**欄位處理策略**：
1. ✅ `current_department`：所有歷史資料預設為「淡海」
2. ✅ `hire_year_month`：從員工編號自動解析（如 1011M0095 → 2021-11）
3. ✅ `phone/email/緊急聯絡人`：保持 NULL，後續手動補充
4. ❌ `assessment_standards`：不遷移，新系統使用新版本

**執行時程**：
- 遷移方案已確定（詳見 `docs/data_migration_plan.md`）
- 遷移腳本開發：Phase 0
- 正式執行：待使用者通知（Phase 0 完成後）

**影響範圍**：
- 資料模型需包含 `current_department` 與 `hire_year_month` 欄位
- 需提供員工編號解析函式
- 需開發遷移腳本 `scripts/migrate_from_sqlite.py`

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 系統管理員初始化系統配置 (Priority: P0)

系統管理員需要為淡海和安坑兩個部門分別配置 Google 服務連接資訊。

**Why this priority**: 這是系統運行的前置條件，沒有配置就無法連接外部服務。

**Independent Test**: 管理員登入後進入系統設定頁面，分別設定淡海和安坑的 Google Sheets ID、Drive 資料夾 ID，完成 Google Drive OAuth 授權，儲存後重新載入頁面確認設定保留。

**Acceptance Scenarios**:

1. **Given** 管理員登入系統，**When** 進入「系統設定」頁面，**Then** 顯示淡海和安坑兩個部門的設定區塊
2. **Given** 在淡海設定區塊，**When** 填寫班表 Sheets ID、勤務表 Sheets ID、Drive 資料夾 ID（4個文件類型），**Then** 設定儲存到資料庫
3. **Given** 在淡海設定區塊，**When** 點擊「授權 Google Drive」按鈕並完成 OAuth 授權流程，**Then** 系統儲存加密的 refresh_token 並顯示「✓ Google Drive 已授權（淡海）」
4. **Given** 在安坑設定區塊，**When** 填寫相同類型的設定項目並完成獨立授權，**Then** 獨立儲存，不影響淡海設定
5. **Given** 設定已儲存，**When** 重新載入頁面，**Then** 所有設定項目正確顯示，OAuth 授權狀態保留

---

### User Story 2 - 員工資料管理（含部門與調動） (Priority: P1)

值班台人員需要能夠管理員工基本資料，包含新增、編輯、標記離職、記錄調動。

**Why this priority**: 員工資料是所有其他模組的基礎，必須優先建立。

**Independent Test**: 淡海值班台人員新增一位員工，填寫編號、姓名、聯絡資訊，系統自動解析入職年月並設定部門為淡海。後續該員工調動到安坑，記錄調動歷史。

**Acceptance Scenarios**:

1. **Given** 淡海值班台人員登入，**When** 點擊「新增員工」並填寫員工編號「1011M0095」、姓名「張三」，**Then** 系統自動解析入職年月為「2021-11」，部門預設為「淡海」
2. **Given** 填寫員工資料，**When** 填寫手機、Email、緊急聯絡人（選填），**Then** 資料儲存成功
3. **Given** 管理員登入，**When** 對員工「張三」執行「記錄調動」，選擇目標部門「安坑」、調動日期「2026-03-01」，**Then** 建立調動記錄，員工當前部門更新為「安坑」
4. **Given** 淡海值班台人員登入，**When** 查看員工「張三」的調動前記錄，**Then** 可查看但無法編輯（唯讀）
5. **Given** 安坑值班台人員登入，**When** 查看員工「張三」的調動後記錄，**Then** 可查看且可編輯

---

### User Story 3 - 權限控制與資料過濾 (Priority: P1)

系統必須根據使用者角色和部門限制資料存取權限。

**Why this priority**: 資料安全與權限控制是核心需求，必須從一開始就正確實作。

**Independent Test**: 淡海值班台人員登入後，列表預設顯示淡海部門資料，但可查詢安坑資料（唯讀）。主管可查看所有部門資料。

**Acceptance Scenarios**:

1. **Given** 淡海值班台人員登入，**When** 進入員工列表頁面，**Then** 預設篩選條件為「部門=淡海」，可切換查看安坑
2. **Given** 淡海值班台人員查看淡海員工，**When** 點擊編輯按鈕，**Then** 可以編輯所有欄位
3. **Given** 淡海值班台人員查看安坑員工，**When** 點擊編輯按鈕，**Then** 按鈕為灰色或提示「無權限編輯他部門資料」
4. **Given** 主管登入，**When** 查看員工列表，**Then** 可看到所有部門資料，但無編輯按鈕
5. **Given** 管理員登入，**When** 查看員工列表，**Then** 可看到所有部門資料，且可編輯所有記錄

---

### User Story 4 - Google Sheets 班表自動同步與手動觸發 (Priority: P2) ⭐ **(已擴充)**

系統每日自動從 Google Sheets 同步班表資料到資料庫，並提供手動同步功能供管理員即時更新資料。

**Why this priority**: 班表資料是差勤考核的基礎，需要自動化減少人工操作。手動同步功能可處理自動排程失敗或需要即時資料的情況。

**Independent Test**: 系統在凌晨 2:00 自動執行同步任務，從淡海和安坑的 Google Sheets 讀取當月班表並寫入資料庫。管理員可在任何時間點點擊「立即同步」按鈕手動觸發同步。

**Acceptance Scenarios**:

1. **Given** 系統在 Render 運行並由 UptimeRobot 保持喚醒，**When** 時間到達凌晨 2:00，**Then** 自動觸發班表同步任務（淡海）
2. **Given** 班表同步任務執行，**When** 連接淡海的 Google Sheets，**Then** 使用淡海的 API 憑證和唯讀權限
3. **Given** 班表資料讀取成功，**When** 解析班表分頁（如「11501班表」），**Then** 寫入資料庫並標記部門為「淡海」
4. **Given** 淡海同步完成，**When** 執行安坑同步任務，**Then** 使用安坑的 API 憑證與 Sheets ID
5. **Given** 同步過程發生錯誤，**When** 錯誤發生，**Then** 記錄錯誤日誌並通知管理員（Email 或系統通知）
6. **Given** 管理員登入系統，**When** 進入「Google 服務管理」頁面並點擊「立即同步班表（淡海）」，**Then** 立即觸發同步任務並顯示進度
7. **Given** 手動同步執行中，**When** 同步進行，**Then** 顯示即時進度（已處理 X 筆 / 共 Y 筆）並可取消
8. **Given** 手動同步完成，**When** 同步結束，**Then** 顯示結果統計（新增 N 筆、更新 N 筆、失敗 N 筆）

---

### User Story 5 - 駕駛時數統計與競賽排名 (Priority: P3)

系統每日同步勤務表資料，每季自動計算駕駛競賽排名。

**Why this priority**: 駕駛競賽是新增功能，優先級低於核心履歷與考核功能。

**Independent Test**: 系統每季首日（1/1, 4/1, 7/1, 10/1）凌晨 3:00 計算前一季度駕駛競賽排名，按部門分別排名（淡海前5名、安坑前3名）。

**Acceptance Scenarios**:

1. **Given** 管理員登入系統，**When** 進入「勤務標準時間管理」頁面，**Then** 可新增、編輯、刪除勤務標準時間（如「淡安-全」= 480 分鐘）
2. **Given** 管理員上傳勤務標準時間 Excel 檔案，**When** 系統驗證資料格式，**Then** 批次匯入成功並顯示匯入筆數
3. **Given** 系統在凌晨 2:30 執行勤務表同步，**When** 讀取淡海勤務表並查詢 `route_standard_times` 表，**Then** 計算每位員工的每日駕駛分鐘數並寫入 `driving_daily_stats`
4. **Given** 班表標示某員工當日為 R班出勤，**When** 計算駕駛時數，**Then** 該日時數 × 2 計入 R班加成
5. **Given** 每季首日（1/1, 4/1, 7/1, 10/1）凌晨 3:00，**When** 觸發競賽排名計算任務，**Then** 彙總前一季度所有員工的駕駛時數並套用公式計算最終積分
6. **Given** 計算最終積分（= (Σ 每日實際駕駛時數 × R班係數) / (1 + 責任事件次數)），**When** 計算完成，**Then** 按積分由高到低排名並寫入 `driving_competition`
7. **Given** 員工季度累計時數 < 300小時 或 季末已離職，**When** 資格檢查，**Then** 標記為不符合資格（bonus_amount = 0）
8. **Given** 淡海分部排名計算完成，**When** 分配獎金，**Then** 僅前5名符合資格者獲得獎金（3600/3000/2400/1800/1200元）
9. **Given** 安坑分部排名計算完成，**When** 分配獎金，**Then** 僅前3名符合資格者獲得獎金（3600/3000/2400元）
10. **Given** 排名計算完成，**When** 主管查詢駕駛競賽報表，**Then** 顯示所有員工排名、積分、部門排名、資格狀態、獎金金額
11. **Given** 查詢 2026 Q1 競賽結果，**When** 指定季度參數（year=2026, quarter=1），**Then** 返回該季度（2026/1-3月）的排名資料
12. **Given** 責任事件從履歷系統統計 S/R 類別事件，**When** 計算懲罰係數，**Then** 實際積分 = 原始時數 / (1 + 事件次數)

---

### User Story 6 - 系統連線狀態監控與憑證驗證 (Priority: P2) ⭐ **(Gemini 建議新增)**

桌面應用程式必須常駐顯示雲端服務與 Google API 的連線狀態，並在管理員上傳 API 憑證時立即驗證其有效性。

**Why this priority**: 連線狀態即時回饋可幫助使用者快速診斷問題（網路 vs 伺服器），憑證驗證可避免配置錯誤導致後續功能異常。

**Independent Test**: 桌面應用啟動後在狀態列顯示「雲端連線：正常」與「Google API：正常」。管理員上傳淡海的 Google 憑證時，系統立即嘗試連接並回報結果。

**Acceptance Scenarios**:

1. **Given** 桌面應用啟動完成，**When** 連接雲端 FastAPI 成功，**Then** 狀態列顯示「☁️ 雲端：已連線」（綠色圖示）
2. **Given** 桌面應用運行中，**When** 雲端 API 無法連接（網路問題或 Render 休眠），**Then** 狀態列顯示「☁️ 雲端：連線失敗」（紅色圖示）並提示「請檢查網路連線」
3. **Given** 系統已配置 Google API 憑證，**When** 應用啟動時測試 Google Sheets 連線，**Then** 狀態列顯示「📊 Google：已連線（淡海✓ 安坑✓）」
4. **Given** Google API 憑證過期或權限不足，**When** 測試連線失敗，**Then** 狀態列顯示「📊 Google：連線異常（淡海✗）」並提示管理員檢查憑證
5. **Given** 管理員在系統設定上傳淡海的 Google 憑證 JSON，**When** 點擊「驗證憑證」按鈕，**Then** 系統立即嘗試連接 Google Sheets API（Dry Run）
6. **Given** 憑證驗證測試執行，**When** 權限正確且可連線，**Then** 顯示「✓ 憑證有效，已成功連接 Google Sheets」並允許儲存
7. **Given** 憑證驗證測試失敗，**When** 權限不足或檔案格式錯誤，**Then** 顯示具體錯誤訊息（如「權限不足：缺少 spreadsheets.readonly」）並拒絕儲存
8. **Given** 使用者嘗試上傳檔案時系統偵測 OAuth refresh_token 失效（使用者在 Google 撤銷授權），**When** 授權驗證失敗，**Then** 顯示「Google Drive 授權已失效，請聯繫管理員」並發送 Email 通知管理員（kunpeto.chen@gmail.com）
9. **Given** 使用者在無網路環境下操作，**When** 狀態列顯示連線失敗，**Then** 系統提示「已進入離線模式，部分功能不可用」（若實作本地快取）

---

### User Story 7 - PDF 條碼識別（含部門判斷） (Priority: P2)

桌面應用程式處理 PDF 掃描文件，根據條碼前綴（TH/AK）自動判斷部門並上傳到對應的 Google Drive 資料夾。

**Why this priority**: PDF 處理是前專案功能，需調整以支援雙部門。

**Independent Test**: 使用者上傳一個包含多頁的 PDF，條碼為「TH-12345」和「AK-67890」，系統自動切分為兩個檔案並上傳到淡海和安坑的 Drive 資料夾。

**Acceptance Scenarios**:

1. **Given** 使用者在桌面應用上傳 PDF，**When** 系統識別條碼「TH-12345」，**Then** 判定部門為「淡海」
2. **Given** 條碼識別完成，**When** 切分 PDF，**Then** 根據條碼對應的履歷 ID 自動命名檔案
3. **Given** 檔案準備上傳，**When** 上傳到 Google Drive，**Then** 使用淡海的 Drive 憑證和資料夾 ID
4. **Given** PDF 中包含「AK-67890」條碼，**When** 處理該頁面，**Then** 判定部門為「安坑」並上傳到安坑 Drive
5. **Given** 上傳完成，**When** 更新履歷狀態，**Then** 記錄 Google Drive 連結並標記為已結案

---

### User Story 8 - 司機員事件履歷管理系統 (Priority: P1) ⭐ **(新增 + Gemini Review 優化)**

值班台人員需要能夠記錄和管理司機員的各類事件履歷，包括事件調查、人員訪談、考核加扣分、矯正措施等，並自動產生對應的 Office 文件。

**Why this priority**: 事件履歷是司機員考核管理的核心，所有事件記錄都需要完整的文件化流程。

**Independent Test**: 值班台人員建立一筆基本履歷後，將其轉換為「人員訪談」類型，系統自動從本地資料庫（schedules 表）查詢該員工事件當天前後的班別資訊，填充資料後在後端產生 Word 文件並嵌入條碼，直接下載到瀏覽器。

**架構優化** ⭐ **(Gemini Review 2026-01-30 + Render 免費版評估)**:
- ✅ **Office 文件生成移至後端**（python-docx/openpyxl 可在 Render 免費版運行，每天 < 10 份無記憶體壓力）
- ✅ **條碼版本號機制**（格式：`{profile_id}|{type_code}|{YYYYMM}|V{version}`，防止同一履歷多次生成條碼重複）
- ✅ **班表查詢優先本地 DB**（優先查詢 schedules 表，僅在必要時呼叫 Google API）
- ✅ **履歷轉換規則明確**（僅允許 basic → 專業類型，防止資料遺失）
- ✅ **EventInvestigation 強化統計欄位**（新增 has_responsibility、category，支援 Phase 9 駕駛競賽責任事件統計）

**資料模型修正** ⭐ **(Gemini 模板欄位驗證 2026-01-30)**:
- ✅ **Profile 主表擴充**：新增 event_time、event_title、data_source、assessment_item、assessment_score 欄位
  - 設計理由：所有 Profile 類型都可能需要考核資訊，將這些欄位提升至主表確保「一事一檔」資料一致性
- ✅ **PersonnelInterview 模型補完**：
  - 新增 `interview_result_data` (JSON)：儲存訪談結果勾選 (ir_1~ir_7, ir_other_text)
  - 新增 `follow_up_action_data` (JSON)：儲存後續行動勾選 (fa_1~fa_7, fa_other_text)
  - 新增 `conclusion` (TEXT)：結論欄位
  - 設計理由：使用 JSON 欄位保持彈性，避免新增 16+ 個 Boolean 欄位
- ✅ **欄位映射邏輯標準化**：建立完整的模板佔位符與資料庫欄位映射表（詳見 `backend/src/templates/README.md`）

**Acceptance Scenarios**:

1. **Given** 值班台人員登入系統，**When** 點擊「新增履歷」並填寫事件日期、員工姓名、事件地點、列車車號、事件描述，**Then** 系統建立基本履歷（profile_type='basic', conversion_status='pending'）並儲存到資料庫
2. **Given** 基本履歷已建立，**When** 點擊「轉換類型」並選擇「事件調查」，**Then** 系統彈出事件調查表單，包含事故時間、地點、目擊者、原因、經過、改善建議、**是否歸責（has_responsibility）**、**責任比例（0-100%）**、**事件類別（S/R/W/O/D）** 等欄位 ⭐
3. **Given** 填寫事件調查表單，**When** 點擊「儲存並產生文件」，**Then** 系統將表單資料儲存到資料庫（刪除舊子表資料，建立 EventInvestigation 記錄），在後端使用 python-docx 產生 Word 文件，嵌入 Code128 條碼（編碼格式：`12345|EI|202601|V01`），返回檔案流供下載 ⭐
4. **Given** Word 文件產生完成，**When** 瀏覽器接收檔案流，**Then** 自動觸發下載，檔案命名為「事件調查-20260115_1234_淡水站_張三.docx」，使用者可選擇儲存位置 ⭐
5. **Given** 履歷已轉換為「人員訪談」，**When** 系統載入表單，**Then** 自動從本地 schedules 表查詢該員工事件當天、前一天、前兩天的班別資訊（若本地無資料且距今 < 7 天，才即時呼叫 Google Sheets API 並同步）⭐
6. **Given** 履歷已產生文件，**When** 使用者上傳掃描後的 PDF 到 Google Drive，**Then** 系統記錄 Google Drive 連結（gdrive_link），更新履歷狀態為「completed」，從未結案列表中移除
7. **Given** 值班台人員查詢履歷，**When** 使用日期區間、員工姓名、列車車號、地點、關鍵字等條件篩選，**Then** 顯示符合條件的所有履歷記錄
8. **Given** 履歷包含考核項目，**When** 建立考核記錄，**Then** 系統自動統計該員工該類別的年度累計次數並計算加重分數（適用 2026 年起）
9. **Given** 使用者嘗試轉換已完成的履歷（conversion_status='completed'），**When** 點擊「轉換類型」，**Then** 系統提示「已完成的履歷不可轉換」並拒絕操作 ⭐
10. **Given** 使用者嘗試將「事件調查」轉換為「人員訪談」，**When** 點擊「轉換類型」，**Then** 系統警告「轉換將刪除現有事件調查資料，確定繼續？」⭐

**履歷類型與狀態**:
- **基本履歷（basic）**: 所有履歷的初始狀態
- **事件調查（event_investigation）**: 事故調查記錄，包含調查人員、原因分析、改善建議、**是否歸責、責任比例、事件類別** ⭐
- **人員訪談（personnel_interview）**: 訪談記錄，自動帶入員工到職日期、事件前後班別
- **考核加扣分通知單（assessment_notice）**: 考核通知，包含加分/扣分類型、理由、核發日期
- **矯正措施（corrective_measures）**: 矯正措施記錄，包含事件概述、矯正行動、完成期限、完成狀態

**履歷狀態流轉**:
```
pending (待處理) → converted (已轉換) → completed (已完成)
                      ↓ 產生文件
                      ↓ 上傳 PDF 到 Drive
```

**轉換規則** ⭐:
1. ✅ basic → 任何專業類型
2. ❌ 專業類型 → 其他專業類型（需警告資料將遺失）
3. ❌ completed 狀態不可轉換

**Office 文件命名規則**:
- 事件調查/人員訪談/矯正措施：`類型-YYYYMMDD_車號_地點_姓名.docx`
- 考核加扣分：`類型_YYYYMMDD_姓名.xlsx`

**條碼編碼格式** ⭐: `{profile_id}|{type_code}|{YYYYMM}|V{version:02d}`
- profile_id: 履歷 ID（如 12345）
- type_code: EI（事件調查）、PI（人員訪談）、CM（矯正措施）、AA（考核加分）、AD（考核扣分）
- YYYYMM: 產生文件的年月（如 202601）
- version: 版本號（如 V01, V02，每次重新生成文件時遞增）
- 範例：`12345|EI|202601|V01`

---

### User Story 9 - 考核系統（累計加重機制與雙因子評分） (Priority: P2) ⭐ **(新增)**

系統需要支援 2026 年度的新考核規則，包含考核標準表管理、依類別累計加重機制、R02-R05 雙因子評分機制、月度獎勵自動計算、年度自動重置。系統同時需要與履歷系統深度整合，當建立 R02-R05 相關履歷時自動觸發責任判定流程。

**Why this priority**: 2026 年起考核制度全面升級，新增累計加重機制（依類別獨立累計）、R02-R05 雙因子評分（延誤時間 × 責任程度），以及月度獎勵機制，需要系統自動化支援以確保公平性與效率。

**Independent Test**:
1. 員工「張三」在 2026 年 1 月發生第 1 次 D 類違規（D01 遲到）扣 1 分，2 月發生第 2 次 D 類違規扣 1.5 分（累計加重 1.5 倍），系統自動計算 D 類累計次數並套用加重公式
2. 員工「李四」發生延誤 7 分鐘事件（R04），經責任判定查核表判定有 4 項疏失（主要責任，係數 0.7），系統自動計算：實際扣分 = -3 × 0.7 = -2.1 分，若為該員工年度第 3 次 R 類違規，最終扣分 = -2.1 × 2.0 = -4.2 分
3. 月底時，系統自動檢查員工「王五」當月 R 類、S 類無任何扣分，自動發放 +M02 月度行車零違規 +1 分；若所有類別皆零違規，再加 +M03 全項目零違規 +2 分（可疊加）

**Acceptance Scenarios**:

#### A. 考核標準表管理

1. **Given** 管理員登入系統，**When** 進入「考核標準管理」頁面，**Then** 顯示所有 61 項考核標準（41 項扣分 + 20 項加分），分類顯示：D-差勤、W-工作、O-運轉、S-安全、R-異常處理、+M-月度獎勵、+A-出勤配合、+B-支援業務、+C-運轉表現、+R-異常處理加分
2. **Given** 管理員新增考核項目「D01 遲到/早退」，**When** 設定代碼「D01」、類別「D」、基本分數「-1」、是否累計加重「是」，**Then** 資料儲存到 `assessment_standards` 資料表
3. **Given** 管理員上傳 Excel 考核標準表，**When** 系統解析檔案，**Then** 批次匯入所有標準項目，重複代碼則更新，新代碼則新增
4. **Given** 值班台搜尋考核項目，**When** 輸入關鍵字「遲到」，**Then** 系統搜尋項目名稱欄位，返回「D01 遲到/早退」

#### B. 累計加重機制（依類別獨立累計）

5. **Given** 值班台為員工「張三」建立 D01 遲到扣分（事件日期 2026-02-15），**When** 系統查詢該員工 2026 年度 D 類累計次數，**Then** 發現已有 1 次，判定此次為第 2 次
6. **Given** 此次為第 2 次 D 類扣分，**When** 系統計算扣分，**Then** 套用累計加重公式：實際扣分 = -1 × [1 + 0.5 × (2-1)] = -1.5 分
7. **Given** 員工「張三」同日又發生 S01 超速（S 類），**When** 系統查詢 S 類累計次數，**Then** 發現為 0 次，判定此次為第 1 次，扣分 = -3 × 1.0 = -3 分（D 類和 S 類獨立累計）
8. **Given** 考核記錄儲存，**When** 寫入 `assessment_records` 資料表，**Then** 記錄包含 `base_points=-1`, `cumulative_multiplier=1.5`, `actual_points=-1.5`, `final_points=-1.5`, `cumulative_count=2`
9. **Given** 值班台刪除某筆考核記錄，**When** 刪除完成，**Then** 系統自動重算該員工該年度該類別的所有記錄，重新計算累計次數與加重分數（使用資料庫 Transaction 確保並發安全）

#### C. R02-R05 雙因子評分機制 ⭐ **核心新增**

10. **Given** 員工「李四」發生延誤事件（延誤 7 分鐘），**When** 值班台建立考核記錄並選擇「R04 人為疏失延誤 5~10 分鐘」，**Then** 系統自動帶出「責任判定查核表」介面，包含 9 項疏失查核項目
11. **Given** 值班台勾選疏失查核表，**When** 勾選了「通報延遲」、「不熟悉程序」、「操作錯誤」、「未主動回報」共 4 項，**Then** 系統判定為「主要責任」（4-6 項），責任係數 = 0.7
12. **Given** 責任係數確定，**When** 系統計算扣分，**Then** 實際扣分 = R04 基本分 -3 × 責任係數 0.7 = -2.1 分
13. **Given** 系統查詢該員工 2026 年度 R 類累計次數（R02-R05 合併計算），**When** 發現為第 3 次，**Then** 累計倍率 = 1 + 0.5 × (3-1) = 2.0，最終扣分 = -2.1 × 2.0 = -4.2 分
14. **Given** 考核記錄儲存，**When** 寫入 `assessment_records` 和 `fault_responsibility_assessments`，**Then** 記錄包含基本分、責任係數、實際扣分、累計倍率、最終扣分、9 項查核結果（JSON 格式）
15. **Given** 管理員查詢該筆記錄，**When** 檢視詳情，**Then** 顯示完整計算過程：延誤時間 7 分鐘 → R04（-3 分）→ 疏失 4 項（主要責任 ×0.7）→ 實際扣分 -2.1 → 第 3 次（×2.0）→ 最終扣分 -4.2

#### D. 履歷系統整合 - R02-R05 自動觸發責任判定 ⭐ **特別新增**

16. **Given** 值班台建立「人為疏失延誤」事件履歷（ProfileType = EVENT_INVESTIGATION），**When** 選擇考核項目為 R02/R03/R04/R05 之一，**Then** 系統自動判定此履歷需要進行責任判定，顯示「此事件需進行責任判定」提示
17. **Given** 履歷建立流程中，**When** 確認考核項目為 R02-R05，**Then** 系統自動嵌入「責任判定查核表」區塊，包含：
    - 時間節點記錄（T0 事件發生、T1 察覺異常、T2 開始處理、T3 故障排除完成、T4 恢復運轉）
    - 延誤秒數欄位（自動計算或手動輸入）
    - 9 項疏失查核項目（checkbox）
18. **Given** 值班台填寫查核表，**When** 勾選疏失項目並儲存履歷，**Then** 系統同時建立：
    - `Profile` 記錄（履歷基本資料）
    - `AssessmentRecord` 記錄（考核扣分記錄，含累計倍率）
    - `FaultResponsibilityAssessment` 記錄（責任判定詳細資料）
19. **Given** 責任判定資料已儲存，**When** 產生 Word 文件（事件調查表），**Then** 文件中自動包含：
    - 責任判定結果（完全/主要/次要）
    - 疏失項數統計（X 項 / 9）
    - 計算過程（基本分 × 責任係數 × 累計倍率）
    - 9 項查核明細
20. **Given** 履歷已建立且含責任判定，**When** 值班台修改責任判定結果（重新勾選疏失項目），**Then** 系統自動重新計算責任係數、實際扣分、最終扣分，並更新考核記錄

#### E. 月度獎勵自動計算 ⭐ **核心新增**

21. **Given** 每月 1 日凌晨，**When** 系統執行月度獎勵計算排程，**Then** 掃描所有員工上個月的考核記錄
22. **Given** 員工「王五」2026 年 1 月無任何 R 類、S 類扣分，**When** 系統計算月度獎勵，**Then** 自動建立 +M02 月度行車零違規記錄（+1 分）
23. **Given** 員工「王五」2026 年 1 月所有類別（D/W/O/S/R）皆無扣分，**When** 系統計算月度獎勵，**Then** 自動建立 +M02（+1 分）和 +M03 月度全項目零違規（+2 分），合計 +3 分（可疊加）
24. **Given** 員工「張三」2026 年 1 月有 D 類扣分（但 R、S 類零違規），**When** 系統計算月度獎勵，**Then** 僅建立 +M02（+1 分），不發放 +M03
25. **Given** 月度獎勵計算完成，**When** 查詢 `monthly_rewards` 資料表，**Then** 每位員工每月僅有一筆記錄，包含 full_attendance、driving_zero_violation、all_zero_violation、total_points 欄位

#### F. 年度重置機制 ⭐ **核心新增**

26. **Given** 每年 1 月 1 日凌晨，**When** 系統執行年度重置排程，**Then** 執行以下操作：
    - 所有員工的 `current_score` 重設為 80 分
    - 所有 `cumulative_counters` 記錄的 `count` 重設為 0
    - 歷史記錄（`assessment_records`）保留不刪除
27. **Given** 年度重置完成，**When** 查詢員工「張三」的考核資料，**Then** 顯示當前分數 80 分、各類別累計次數 0 次，但歷史記錄仍可查詢（依年度篩選）

#### G. 履歷日期變更的連動重算 ⭐ **P1 新增（Gemini Review 建議）**

28. **Given** 值班台修改履歷「張三-2026-02-15-遲到」的事件日期，**When** 將日期從 2026-02-15 改為 2026-01-10，**Then** 系統自動同步更新關聯的考核記錄日期（`AssessmentRecord.record_date`）
29. **Given** 考核記錄日期已變更，**When** 系統檢測到該員工 2026 年度 D 類有多筆記錄，**Then** 系統自動重算所有 D 類記錄的累計次數與倍率（依 record_date 排序）
30. **Given** 重算前狀態：
    - 2026-01-15: D01（第1次，×1.0，-1分）
    - 2026-02-20: D01（第2次，×1.5，-1.5分）
    **When** 將 2月20日的記錄改為 2026-01-10，**Then** 重算後狀態：
    - 2026-01-10: D01（第1次，×1.0，-1分）
    - 2026-01-15: D01（第2次，×1.5，-1.5分）← 累計次數自動調整
31. **Given** 值班台修改履歷日期為**跨年變更**，**When** 將 2026-12-31 的 D01 記錄改為 2027-01-05，**Then** 系統同時重算：
    - 2026 年度所有 D 類記錄（移除該筆後重算）
    - 2027 年度所有 D 類記錄（新增該筆後重算）
32. **Given** 日期變更與重算完成，**When** 查詢員工總分，**Then** `Employee.current_score` 已自動更新為所有 `final_points` 的總和（起始分 80 + 所有考核分數）
33. **Given** 多個值班台同時修改同一員工的不同履歷日期，**When** 並發執行重算，**Then** 系統使用 Transaction + FOR UPDATE 鎖定，確保重算結果正確（無 Race Condition）

#### H. 員工考核查詢

34. **Given** 管理員查詢員工「張三」的年度考核摘要，**When** 選擇年度「2026」，**Then** 顯示：
    - 當前總分
    - 各類別累計次數（D: 2 次、W: 0 次、O: 1 次、S: 1 次、R: 3 次）
    - 所有考核記錄（時間、項目、基本分、責任係數、累計倍率、最終分數）
35. **Given** 員工查詢自己的考核記錄，**When** 進入「我的考核」頁面，**Then** 顯示當前分數、月度獎勵統計、扣分明細（含計算過程）

**累計加重公式**:
```
累計倍率 = 1 + 0.5 × (N - 1)
最終扣分 = 實際扣分 × 累計倍率

其中：
- N = 該類別年度累計次數
- 實際扣分 = 基本分（一般項目）或 基本分 × 責任係數（R02-R05）
```

**累計倍率對照表**:
| 累計次數 | 倍率 | 計算式 |
|---------|------|--------|
| 第 1 次 | ×1.0 | 1 + 0.5 × 0 = 1.0 |
| 第 2 次 | ×1.5 | 1 + 0.5 × 1 = 1.5 |
| 第 3 次 | ×2.0 | 1 + 0.5 × 2 = 2.0 |
| 第 4 次 | ×2.5 | 1 + 0.5 × 3 = 2.5 |
| 第 5 次 | ×3.0 | 1 + 0.5 × 4 = 3.0 |

**R02-R05 雙因子評分機制**:
```
因子一：延誤時間級距 → 基本分
- R02（未延誤但需故障排除）：-1 分
- R03（90秒~5分鐘）：-2 分
- R04（5~10分鐘）：-3 分
- R05（>10分鐘）：-5 分

因子二：責任程度 → 責任係數（透過 9 項疏失查核表判定）
- 完全責任（7 項以上）：×1.0
- 主要責任（4-6 項）：×0.7
- 次要責任（1-3 項）：×0.3

實際扣分 = 基本分 × 責任係數
最終扣分 = 實際扣分 × 累計倍率
```

**9 項疏失查核表**:
1. 察覺過晚或誤判
2. 通報延遲或不完整
3. 不熟悉故障排除程序
4. 故障排除決策/操作錯誤
5. 動作遲緩
6. 未確認結果或誤認完成
7. 未主動回報處理進度
8. 重複性錯誤
9. 心理狀態影響表現

**月度獎勵機制**:
- **+M01 月度全勤**：+3 分（另外處理，不在此範圍）
- **+M02 月度行車零違規**：+1 分（當月 R 類、S 類無任何扣分）
- **+M03 月度全項目零違規**：+2 分（當月所有類別無任何扣分）
- **+M02 與 +M03 可疊加**，最高每月 +3 分（+M02 +1 + +M03 +2）

**累計類別規則** ⭐ **P1 明確化（Gemini Review 建議）**:
- **D 類、W 類、O 類、S 類**：各自獨立累計
- **R 類特殊**：**僅 R02/R03/R04/R05 合併計算**累計次數（因都屬人為疏失異常處理）
  - 明確定義：`R_CUMULATIVE_GROUP = {'R02', 'R03', 'R04', 'R05'}`
  - 若未來新增 R01、R06 等項目，**不納入**此合併群組，各自獨立累計
  - 避免誤將非人為疏失的 R 類項目錯誤合併計算

**年度重置**:
- 每年 1/1 自動重置所有員工分數為 80 分
- 所有類別累計次數歸零
- 歷史記錄保留（不刪除）

**考核標準表管理**:
- 系統預設 61 項考核標準（41 項扣分 + 20 項加分）
- 支援上傳 Excel 考核標準表批次匯入/更新
- 支援 CRUD 操作（新增、編輯、查詢、軟刪除）

---

### User Story 10 - 差勤加分自動處理 (Priority: P2) ⭐ **(新增 + 整合 Phase 12 月度獎勵)**

系統需要能夠自動從 Google Sheets 班表讀取資料，逐員工判斷全勤、R班出勤、延長工時等差勤加分情況，批次建立對應的考核記錄，並觸發月度獎勵計算（+M02/+M03）。

**Why this priority**: 差勤加分是每月例行作業，自動化可大幅減少手動建立履歷的工作量，避免遺漏或錯誤。同時整合月度獎勵計算，確保所有月度加分在同一流程中處理完成。

**Independent Test**: 管理員選擇「2026 年 1 月」並點擊「執行差勤加分處理」，系統讀取淡海班表，發現員工「張三」當月全勤且無任何扣分、員工「李四」有 2 次 R班出勤、員工「王五」有 1 次延長工時 2 小時，系統自動建立對應的考核記錄，並計算月度獎勵（+M02、+M03），最後顯示處理統計。

**架構設計** ⭐ **(Gemini Review 2026-01-30)**:
- **Phase 13（差勤加分）作為主流程**：負責解析班表、判定出勤加分、觸發月度獎勵計算
- **Phase 12（考核系統）提供服務**：MonthlyRewardCalculatorService 負責 +M02/+M03 判定
- **整合邏輯**：Phase 13 完成 +A 系列加分後，傳遞全勤狀態給 Phase 12，由 Phase 12 建立 +M01/+M02/+M03 的考核記錄

**Acceptance Scenarios**:

#### A. 班表解析與出勤加分（+A 系列）

1. **Given** 管理員登入系統，**When** 進入「差勤加分處理」頁面並選擇「2026 年 1 月」、「淡海」，**Then** 系統連接 Google Sheets 班表（分頁：11501班表）
2. **Given** 班表資料讀取成功，**When** 系統掃描員工「張三」的整月班表，**Then** 發現所有儲存格都不包含「(假)」字樣，判定符合全勤條件
3. **Given** 系統掃描員工「李四」的班表，**When** 發現 1/5 顯示「R/0905G」、1/12 顯示「R(國)/1425G」，**Then** 判定有 2 次 R班出勤
4. **Given** 員工有 R班出勤，**When** 系統建立考核記錄，**Then** 分別建立 2 筆 AssessmentRecord，考核項目為「+A01 R班出勤」（+3 分/次），記錄日期為實際出勤日期
5. **Given** 系統掃描員工「王五」的班表，**When** 發現 1/8 顯示「1425G(+2)」，**Then** 判定有 1 次延長工時 2 小時
6. **Given** 員工有延長工時，**When** 系統建立考核記錄，**Then** 建立 AssessmentRecord，考核項目為「+A04 延長工時 2 小時」（+1.0 分）
7. **Given** 班表儲存格為「R/0905G(+2)」（複合情況），**When** 系統解析，**Then** 同時建立「+A01 R班出勤」和「+A04 延長工時 2 小時」兩筆考核記錄

#### B. 月度獎勵整合（+M 系列）⭐ **新增**

8. **Given** 所有員工的 +A 系列加分處理完成，**When** 系統呼叫 MonthlyRewardCalculatorService，**Then** 傳入每位員工的全勤狀態（is_full_attendance）
9. **Given** 員工「張三」符合全勤條件，**When** Phase 12 服務處理，**Then** 建立 AssessmentRecord：考核項目「+M01 月度全勤」（+3 分），記錄日期為當月最後一天
10. **Given** 員工「張三」當月無 R 類、S 類扣分，**When** Phase 12 服務判定 +M02，**Then** 建立 AssessmentRecord：考核項目「+M02 月度行車零違規」（+1 分）
11. **Given** 員工「張三」當月所有類別（D/W/O/S/R）皆無扣分，**When** Phase 12 服務判定 +M03，**Then** 建立 AssessmentRecord：考核項目「+M03 月度全項目零違規」（+2 分）
12. **Given** +M02 和 +M03 可疊加，**When** 員工同時符合兩項條件，**Then** 總計獲得 +3 分（+M02 +1 + +M03 +2）

#### C. 處理結果與防重複

13. **Given** 處理完成，**When** 顯示結果統計，**Then** 顯示「全勤(+M01) X 筆、行車零違規(+M02) Y 筆、全項目零違規(+M03) Z 筆、R班出勤(+A01) A 筆、延長工時(+A03~06) B 筆、跳過 N 筆（已存在）」
14. **Given** 系統執行前檢查資料庫，**When** 發現已存在相同員工、相同日期、相同考核代碼的記錄，**Then** 跳過該筆，避免重複建立
15. **Given** 執行過程中發生錯誤，**When** 班表解析失敗或 API 異常，**Then** 整個 Transaction 回滾，不產生任何部分記錄，並顯示錯誤訊息

**月度加分標準完整清單**:

| 代碼 | 類別 | 項目名稱 | 分數 | 來源 | 觸發時機 |
|------|------|---------|------|------|---------|
| +M01 | +M | 月度全勤 | +3.0 | 班表 | Phase 13 判定 → Phase 12 建立記錄 |
| +M02 | +M | 月度行車零違規 | +1.0 | 考核記錄 | Phase 12 判定（R+S 類無扣分） |
| +M03 | +M | 月度全項目零違規 | +2.0 | 考核記錄 | Phase 12 判定（全類別無扣分） |
| +A01 | +A | R班出勤 | +3.0/次 | 班表 | Phase 13 判定並建立記錄 |
| +A02 | +A | 國定假日出勤 | +1.0/次 | 班表 | Phase 13 判定並建立記錄 |
| +A03 | +A | 延長工時 1 小時 | +0.5 | 班表 | Phase 13 判定並建立記錄 |
| +A04 | +A | 延長工時 2 小時 | +1.0 | 班表 | Phase 13 判定並建立記錄 |
| +A05 | +A | 延長工時 3 小時 | +1.5 | 班表 | Phase 13 判定並建立記錄 |
| +A06 | +A | 延長工時 4 小時 | +2.0 | 班表 | Phase 13 判定並建立記錄 |

**判定規則**:

**1. 月度全勤（+M01）**:
- **條件**: 當月班表所有儲存格都不包含「(假)」字樣
- **分數**: +3 分
- **記錄日期**: 當月最後一天
- **處理方式**: Phase 13 判定全勤狀態，Phase 12 建立 AssessmentRecord

**2. 月度行車零違規（+M02）** ⭐ **新增說明**:
- **條件**: 當月 R 類、S 類無任何扣分記錄
- **分數**: +1 分
- **記錄日期**: 當月最後一天
- **處理方式**: Phase 12 自動判定並建立 AssessmentRecord

**3. 月度全項目零違規（+M03）** ⭐ **新增說明**:
- **條件**: 當月 D/W/O/S/R 類皆無任何扣分記錄
- **分數**: +2 分
- **記錄日期**: 當月最後一天
- **處理方式**: Phase 12 自動判定並建立 AssessmentRecord
- **與 +M02 可疊加**: 若同時符合，可獲得 +M02 (+1) + +M03 (+2) = +3 分

**4. R班出勤（+A01）**:
- **判斷邏輯**: 班表有 `R/...` 或 `R(國)/...`
- **範例**: `R/0905G`, `R(國)/1425G`
- **分數**: +3 分/次
- **記錄日期**: 實際出勤日期

**5. 國定假日出勤（+A02）** ⭐ **新增**:
- **判斷邏輯**: 班表有 `R(國)/...`（國定假日標記）
- **範例**: `R(國)/1425G`
- **分數**: +1 分/次
- **記錄日期**: 實際出勤日期
- **與 +A01 可疊加**: 國定假日 R班出勤同時獲得 +A01 (+3) + +A02 (+1) = +4 分

**6. 延長工時（+A03~+A06）**:
- **判斷邏輯**: 班表有 `(+1)`, `(+2)`, `(+3)`, `(+4)`
- **範例**: `1425G(+2)` = 該班次加班 2 小時
- **分數**:
  - (+1) → +A03 → +0.5 分
  - (+2) → +A04 → +1.0 分
  - (+3) → +A05 → +1.5 分
  - (+4) → +A06 → +2.0 分
- **記錄日期**: 實際出勤日期

**複合情況處理**:
- 範例 1：`R/0905G(+2)` → 同時建立「+A01 R班出勤」和「+A04 延長工時 2 小時」兩筆記錄
- 範例 2：`R(國)/1425G(+2)` → 同時建立「+A01 R班出勤」、「+A02 國定假日出勤」和「+A04 延長工時 2 小時」三筆記錄

**月結處理流程**:
```
Step 1: Phase 13 讀取班表
  ↓
Step 2: Phase 13 逐員工判定並建立 +A 系列記錄（R班、國定假日、延長工時）
  ↓
Step 3: Phase 13 彙整全勤名單（is_full_attendance map）
  ↓
Step 4: Phase 13 呼叫 Phase 12 MonthlyRewardCalculatorService
  ↓
Step 5: Phase 12 建立 +M01 記錄（若符合全勤）
  ↓
Step 6: Phase 12 判定並建立 +M02、+M03 記錄
  ↓
Step 7: 更新 MonthlyReward 總表
  ↓
Step 8: 返回處理統計結果
```

---

### User Story 11 - 未結案管理系統 (Priority: P3) ⭐ **(新增)**

系統需要提供專門的未結案管理功能，列出所有已產生文件但尚未上傳 PDF 到 Google Drive 的履歷，追蹤文件處理進度。

**Why this priority**: 未結案管理可幫助值班台人員追蹤待辦事項，確保所有履歷都完成文件上傳流程，避免遺漏。

**Independent Test**: 值班台人員進入「未結案專區」，看到 5 筆待上傳的事件調查履歷和 3 筆待上傳的人員訪談履歷，選擇其中一筆上傳掃描後的 PDF，系統自動上傳到 Google Drive 並從未結案列表中移除。

**Acceptance Scenarios**:

1. **Given** 履歷已轉換為特定類型（事件調查/人員訪談/矯正措施/考核加扣分）且已產生文件，**When** 系統儲存履歷記錄，**Then** 將 `conversion_status` 設定為「converted」（已轉換但未上傳 PDF）
2. **Given** 值班台人員登入系統，**When** 進入「未結案專區」，**Then** 系統查詢 `Profile` 表中 `conversion_status = 'converted'` 且 `gdrive_link IS NULL` 的記錄，按類型分類顯示（事件調查、人員訪談、矯正措施、考核加扣分）
3. **Given** 未結案列表顯示，**When** 查看列表內容，**Then** 每筆記錄顯示：事件日期、員工姓名、履歷類型、建立日期、檔案路徑
4. **Given** 值班台人員選擇一筆未結案履歷，**When** 點擊「上傳 PDF」並選擇檔案，**Then** 系統透過本機 API 上傳 PDF 到 Google Drive 對應的資料夾（根據類型和日期）
5. **Given** PDF 上傳成功，**When** 系統記錄 Google Drive 連結，**Then** 更新履歷的 `gdrive_link` 欄位並將 `conversion_status` 更新為「completed」（已完成），履歷自動從未結案列表中消失
6. **Given** 上傳過程中發生錯誤（如網路問題），**When** 上傳失敗，**Then** 顯示錯誤訊息「上傳失敗：{錯誤原因}」，`conversion_status` 保持「converted」，記錄保留在未結案列表中，允許重新上傳
7. **Given** 值班台人員需要確認處理進度，**When** 查看未結案統計資訊，**Then** 系統統計 `conversion_status = 'converted'` 的記錄，顯示：各類型待處理案件數量、最舊未結案日期、本月完成率

**未結案狀態流程**:
```
履歷建立（Profile.conversion_status = 'pending'）
  ↓
類型轉換（產生 Word/Excel 文件）
  ↓
【進入未結案列表】← conversion_status = 'converted', gdrive_link = NULL
  ↓
上傳 PDF 到 Google Drive
  ↓
【從未結案列表移除】← conversion_status = 'completed', gdrive_link 已填入
```

**統計資訊**:
- 事件調查待處理：X 筆
- 人員訪談待處理：Y 筆
- 矯正措施待處理：Z 筆
- 考核加扣分待處理：W 筆
- 最舊未結案日期：YYYY-MM-DD
- 本月完成率：N%

---

### Edge Cases

- **跨部門員工的歷史記錄**：員工調動後，原部門值班台查看調動前記錄為唯讀，新部門值班台查看調動前記錄也是唯讀
- **Google API 憑證過期**：顯示明確錯誤訊息並通知管理員，停用該部門的自動同步功能
- **OAuth 授權失效處理流程** ⭐ **(新增)**：
  - **情境**：使用者在 Google 帳戶中撤銷授權，導致 refresh_token 失效
  - **偵測失效**：系統嘗試上傳檔案到 Google Drive 時收到 401/403 錯誤
  - **使用者端提示**：前端顯示「Google Drive 授權已失效，請稍後再試或聯繫管理員」
  - **管理員通知**：系統立即發送 Email 給管理員（kunpeto.chen@gmail.com），內容包含失效部門、觸發使用者、發生時間、錯誤訊息
  - **管理員處理**：登入系統進入「系統設定」頁面，點擊「重新授權 Google Drive（該部門）」按鈕，完成 OAuth 授權流程
  - **恢復正常**：授權完成後，系統恢復正常運作
- **TiDB 儲存空間不足**：系統監控用量，接近 5GB 時發出警告，建議清理舊資料或升級
- **Render 服務休眠**：UptimeRobot 每 10 分鐘 ping 一次 `/health` 端點保持喚醒
- **員工編號解析失敗**：手動輸入入職年月（異常情況，如編號格式變更）
- **PDF 條碼無法識別**：提供手動選擇部門與履歷 ID 的介面
- **同步任務失敗**：記錄錯誤日誌，下次同步時重試，不影響系統其他功能
- **部門設定缺失**：首次啟動時檢查設定完整性，缺失時引導管理員設定

## Requirements *(mandatory)*

### Functional Requirements

#### 系統架構

- **FR-001**: 系統必須支援淡海與安坑雙部門架構，部門資訊硬編碼
- **FR-002**: 系統必須採用三層混合架構：GitHub Pages 網頁應用（前端） + Render FastAPI（雲端後端） + 本機桌面應用 API（檔案處理）
- **FR-002a**: 網頁應用必須託管於 GitHub Pages，使用前端框架（Vue.js 或 React）
- **FR-002b**: 本機桌面應用必須提供 FastAPI 本機 API（預設 localhost:8000），僅負責檔案操作
- **FR-002c**: 系統核心功能（資料瀏覽、履歷建立、員工管理）必須完全運行於網頁端，不依賴桌面應用 ⭐ **(容錯設計)**
- **FR-002d**: 網頁應用必須在啟動時檢測桌面應用 API 連線狀態（`http://localhost:8000/health`）
- **FR-002e**: 當桌面應用不可用時，系統必須禁用檔案生成功能按鈕並顯示「請啟動桌面應用程式」提示 ⭐ **(容錯設計)**
- **FR-003**: 系統必須使用 TiDB MySQL 作為雲端共享資料庫
- **FR-004**: 雲端 FastAPI 必須部署到 Render 免費版
- **FR-005**: 系統必須使用 UptimeRobot 保持 Render 服務 24/7 喚醒

#### 使用者角色與權限

- **FR-006**: 系統必須支援三種使用者角色：Admin、Staff、Manager
- **FR-007**: Admin 必須擁有所有功能權限與系統參數管理權限
- **FR-008**: Staff 必須僅能編輯本部門資料，其他部門資料唯讀
- **FR-009**: Manager 必須僅能查看所有部門資料（唯讀）與產生報表
- **FR-010**: 系統必須在 API 層實作權限檢查中間件

#### 員工資料管理

- **FR-011**: 系統必須支援員工資料 CRUD（新增、編輯、查詢、標記離職）
- **FR-012**: 員工資料必須包含：編號、姓名、部門、入職年月、聯絡資訊（選填）
- **FR-013**: 系統必須從員工編號自動解析入職年月（格式：YYMM，如 1011M0095 → 2021-11）
- **FR-014**: 系統必須支援員工調動記錄，包含調動日期、原部門、目標部門、原因
- **FR-015**: 系統必須在員工調動後更新 `current_department`，保留調動歷史
- **FR-016**: 系統必須支援批次匯入員工資料（Excel）
- **FR-017**: 系統必須支援批次匯出員工資料（Excel）

#### Google 服務整合

- **FR-018**: 系統必須為每個部門獨立配置 Google Sheets ID（班表、勤務表）
- **FR-019**: 系統必須為每個部門獨立配置 Google Drive 資料夾 ID（4種文件類型）
- **FR-020**: 系統必須為每個部門獨立配置 Google API 憑證（服務帳戶憑證使用環境變數，OAuth 令牌使用加密儲存）
- **FR-021**: 系統必須使用唯讀權限連接 Google Sheets
- **FR-022**: 系統必須每日凌晨 2:00 自動同步班表資料（淡海與安坑）
- **FR-023**: 系統必須每日凌晨 2:30 自動同步勤務表資料（淡海與安坑）
- **FR-024**: 系統必須將同步資料標記部門欄位
- **FR-024a**: 系統必須提供「手動同步」功能，允許管理員在任何時間觸發同步 ⭐ **(Gemini 建議)**
- **FR-024b**: 手動同步必須顯示即時進度（已處理 X 筆 / 共 Y 筆）並可取消
- **FR-024c**: 手動同步完成後必須顯示結果統計（新增、更新、失敗筆數）
- **FR-024d**: 系統必須在管理員上傳 Google API 憑證時立即驗證其有效性（Dry Run） ⭐ **(Gemini 建議)**
- **FR-024e**: 憑證驗證必須測試連接 Google Sheets 與 Drive API，並回報具體錯誤（如權限不足）
- **FR-024f**: 憑證驗證失敗時必須拒絕儲存設定，並顯示詳細錯誤訊息

#### 駕駛時數與競賽

- **FR-025**: 系統必須記錄每位員工每日的駕駛時數（分鐘）與 R班出勤狀態
- **FR-026**: 系統必須記錄每位員工每季的責任事件次數（S/R 類別）
- **FR-027**: 系統必須每季首日（1/1, 4/1, 7/1, 10/1）凌晨 3:00 自動計算前一季度駕駛競賽排名 ⭐ **(季度制更新 2026-01-29)**
- **FR-027a**: 系統必須檢查員工季度資格（累計≥300小時 且 季末在職）⭐ **(新增 2026-01-29)**
- **FR-028**: 系統必須分別計算部門內排名（淡海前5名、安坑前3名）⭐ **(更新 2026-01-29)**
- **FR-029**: 系統必須根據駕駛競賽方案計算最終積分（= (Σ 每日實際駕駛時數 × R班係數) / (1 + 責任事件次數)）⭐ **(更新 2026-01-29)**
- **FR-029a**: 系統必須根據部門和排名分配獎金（淡海5階/安坑3階）⭐ **(新增 2026-01-29)**
- **FR-030**: 系統必須提供駕駛競賽排名報表（主管可查詢季度資料）
- **FR-031**: 系統必須提供勤務標準時間管理功能（僅管理員可編輯）⭐ **(新增)**
  - 支援新增、編輯、刪除勤務標準時間
  - 包含欄位：部門、勤務代碼、勤務名稱、標準分鐘數、啟用狀態
  - 部門間勤務設定獨立，不互相影響
  - **變更規則** ⭐ **(已補充 2026-01-28)**：
    - 變更僅影響「變更日期之後」的駕駛時數計算，歷史資料不重新計算
    - 刪除保護：有關聯記錄的勤務標準時間改為「軟刪除」（`is_active = false`），不允許實體刪除
    - 未知勤務代碼處理：勤務表出現未定義的勤務代碼時，該勤務時數計為 0 分鐘，並記錄警告日誌
- **FR-032**: 系統必須支援勤務標準時間的 Excel 批次匯入功能 ⭐ **(新增)**
  - 管理員可上傳 Excel 檔案批次建立勤務標準時間
  - 匯入前進行資料驗證（必填欄位、格式檢查）
  - 提供匯入預覽與錯誤提示
- **FR-033**: 駕駛時數計算必須基於勤務標準時間資料表 ⭐ **(新增)**
  - 從 Google Sheets 勤務表讀取員工當日勤務項目
  - 查詢 `route_standard_times` 表取得對應標準分鐘數
  - 彙總計算每日總駕駛時數

#### 本機桌面應用檔案處理功能 ⭐ **(架構調整)**

##### Word 文件生成
- **FR-031**: 桌面應用 API 必須提供 Word 文件生成端點（POST `/api/generate-word`）
- **FR-032**: 必須支援自訂範本（.docx 格式），從資料庫填充內容
- **FR-033**: 生成的 Word 檔案必須自動命名（員工編號_文件類型_日期.docx）
- **FR-034**: 生成完成後必須返回檔案下載連結或直接觸發下載

##### PDF 處理
- **FR-035**: 桌面應用必須在本機處理 PDF 條碼識別與切分
- **FR-036**: 系統必須在產生 PDF 條碼時加上部門前綴（淡海=TH、安坑=AK）
- **FR-037**: 系統必須根據條碼前綴判斷部門並上傳到對應 Google Drive 資料夾
- **FR-038**: 系統必須使用對應部門的 Google Drive API 憑證
- **FR-039**: PDF 掃描切分後必須自動命名（條碼_履歷ID_日期.pdf）

##### 條碼生成
- **FR-040**: 桌面應用 API 必須提供條碼生成端點（POST `/api/generate-barcode`）
- **FR-041**: 條碼格式必須包含部門前綴 + 履歷 ID（如 TH-12345、AK-67890）
- **FR-042**: 必須支援 Code128 或 QR Code 格式
- **FR-043**: 條碼圖片必須返回 Base64 編碼或 PNG 檔案

##### Google Drive 上傳
- **FR-044**: 桌面應用 API 必須提供檔案上傳端點（POST `/api/upload-to-drive`）
- **FR-045**: 必須支援根據部門選擇對應的 Drive 資料夾 ID 與憑證
- **FR-046**: 上傳成功後必須返回 Google Drive 檔案連結
- **FR-047**: 上傳失敗時必須記錄錯誤日誌並返回明確錯誤訊息

#### 前端網頁應用 ⭐ **(新增)**

- **FR-035**: 網頁應用必須使用前端框架（Vue.js 3 或 React）開發單頁應用（SPA）
- **FR-036**: 網頁應用必須支援響應式設計（RWD），適配桌面與平板裝置
- **FR-037**: 網頁應用必須透過 HTTPS 連接雲端 FastAPI（Render）
- **FR-038**: 網頁應用必須在啟動時檢測本機桌面應用 API 連線狀態
- **FR-039**: 檔案生成功能（Word、PDF、條碼）必須在桌面應用不可用時禁用並提示使用者 ⭐ **(容錯設計)**
- **FR-040**: 核心功能（資料 CRUD、查詢、報表）不得依賴桌面應用，必須完全透過雲端 API 實作 ⭐ **(容錯設計)**

#### 本機桌面應用（檔案處理）

- **FR-041**: 桌面應用必須提供本機 FastAPI API（預設 `http://localhost:8000`）
- **FR-042**: 桌面應用必須實作 CORS 設定，允許來自 GitHub Pages 的跨域請求
  - **允許的 Origin 清單**：
    - `https://kunpeto.github.io` (正式環境，GitHub Pages)
    - `http://localhost:5173` (開發環境，Vite 預設 port)
  - **CORS 配置要求**：
    - 允許的 HTTP 方法：GET, POST, PUT, DELETE, OPTIONS
    - 允許的 Headers：Content-Type, Authorization
    - 允許憑證 (credentials)：true
- **FR-043**: 桌面應用必須提供健康檢查端點（`/health`）供網頁應用檢測
- **FR-044**: 桌面應用必須提供系統托盤圖示，顯示運行狀態（綠色=正常運行、灰色=停止）
- **FR-045**: 桌面應用必須在系統托盤提供右鍵選單（啟動/停止 API、開啟設定、結束程式）
- **FR-046**: 桌面應用必須在啟動時自動啟動本機 FastAPI 服務
- **FR-047**: 桌面應用必須提供設定介面，配置 Google Drive API 憑證
- **FR-048**: 桌面應用 API 失敗時，不得影響網頁應用的核心功能運作 ⭐ **(容錯設計)**

#### 定時任務

- **FR-048**: 雲端 FastAPI 必須使用 APScheduler 管理所有定時任務
- **FR-049**: 定時任務必須包含：班表同步（2:00）、勤務表同步（2:30）、競賽排名計算（3:00）、資料庫備份（4:00）
- **FR-050**: 定時任務失敗必須記錄錯誤日誌並發送通知

#### 本地快取（可選實作） 💡 **(Gemini 建議)**

- **FR-051**: 網頁應用可選實作 IndexedDB 本地快取，儲存員工列表與基本設定
- **FR-052**: 本地快取必須在雲端 API 可用時自動同步更新
- **FR-053**: 本地快取必須在雲端 API 不可用時提供離線查詢功能（唯讀）
- **FR-054**: 系統必須在進入離線模式時明確提示使用者「部分功能不可用」

#### 歷史資料遷移（待確認需求） ⭐ **(Gemini 建議)**

- **FR-055**: 系統必須提供資料遷移工具，從前專案 SQLite 匯入歷史資料（需確認 PC-005）
- **FR-056**: 資料遷移必須支援選擇性匯入（指定年度範圍、特定資料類型）
- **FR-057**: 資料遷移必須包含資料驗證與格式轉換功能
- **FR-058**: 資料遷移完成後必須產生詳細報告（成功、失敗、跳過筆數）

#### 履歷管理系統（User Story 8）⭐ **(新增)**

- **FR-075**: 系統必須支援建立基本履歷，包含事件日期、員工姓名、事件地點、列車車號、事件描述
- **FR-076**: 系統必須支援履歷類型轉換（基本 → 事件調查/人員訪談/考核加扣分/矯正措施）
- **FR-077**: 系統必須為每種履歷類型提供對應的擴展資料表（1:1 關係）
- **FR-078**: 系統必須實作樂觀鎖機制（版本號），防止並發編輯衝突
- **FR-079**: 系統必須支援履歷多條件查詢（日期區間、員工姓名、列車車號、地點、關鍵字）
- **FR-080**: 系統必須透過本機 API 產生 Office 文件（Word/Excel）。**資料流向**：前端從雲端 API 獲取完整資料（履歷資料、員工資料、班表資料等），打包成 JSON Payload 傳送給本機 API。本機 API **嚴禁連接資料庫**，僅負責接收資料、生成文件、嵌入條碼並返回檔案路徑
- **FR-081**: 系統必須在 Word 文件底部嵌入 Code128 條碼（編碼格式：`{profile_id}|{type_code}|{year}|{month}`）
- **FR-082**: 系統必須依照命名規則儲存 Office 檔案：
  - 事件調查/人員訪談/矯正措施：`類型-YYYYMMDD_車號_地點_姓名.docx`
  - 考核加扣分：`類型_YYYYMMDD_姓名.xlsx`
- **FR-083**: 系統必須依照部門和日期建立資料夾結構：`{部門}/{類型}/{年份}/{月份}/`
- **FR-084**: 系統必須在人員訪談表單自動從 Google Sheets 班表取得員工班次資訊（事件當天、前1天、前2天）
- **FR-085**: 系統必須在人員訪談表單自動從員工編號解析到職日期（格式：YYMM → YYYY/MM）
- **FR-086**: 系統必須支援將 PDF 上傳到 Google Drive 並記錄連結。**安全性**：上傳時自動設定檔案權限為「僅網域內可檢視」(domain-wide sharing)，防止連結外洩
- **FR-087**: 系統必須在 PDF 上傳成功後更新履歷狀態為「已完成」
- **FR-088**: 系統必須支援履歷軟刪除（標記 deleted_at，不實際刪除記錄）
- **FR-089**: 系統必須記錄履歷建立者與最後修改者
- **FR-090**: 系統必須支援履歷匯出（Excel 完整版、技安簡化版）

**本機 API Payload 結構範例** (FR-080 補充說明):
```json
{
  "document_type": "personnel_interview",
  "profile_id": 12345,
  "barcode_data": "12345|PI|2026|01",
  "data": {
    "event_date": "2026-01-15",
    "employee_name": "張三",
    "employee_id": "1011M0095",
    "hire_date": "2021/11",
    "event_location": "淡水站",
    "train_number": "1101",
    "shift1": "0905G",
    "shift2": "R/1425G",
    "shift3": "休",
    "interview_content": "...",
    "interviewer": "李四"
  }
}
```

#### 考核系統（累計加重與雙因子評分）（User Story 9）⭐ **(新增)**

##### 考核標準表管理

- **FR-091**: 系統必須支援考核標準表 CRUD 操作（新增、編輯、查詢、軟刪除）
- **FR-092**: 系統必須預設 61 項考核標準（41 項扣分 + 20 項加分），分類為：D-差勤（6項）、W-工作（5項）、O-運轉（16項）、S-安全（8項）、R-異常處理（6項）、+M-月度獎勵（3項）、+A-出勤配合（8項）、+B-支援業務（3項）、+C-運轉表現（1項）、+R-異常處理加分（5項）
- **FR-093**: 系統必須支援考核標準表 Excel 批次匯入功能，支援新增與更新（依 code 判斷）
- **FR-094**: 系統必須支援關鍵字搜尋考核項目（搜尋範圍：code + name 欄位）
- **FR-095**: 每個考核標準必須包含欄位：code（代碼）、category（類別）、name（項目名稱）、base_points（基本分數）、has_cumulative（是否累計加重）、calculation_cycle（計算週期：yearly/monthly）、description（說明）、is_active（是否啟用）

##### 累計加重機制（依類別獨立累計）

- **FR-096**: 系統必須實作累計加重機制，公式：`累計倍率 = 1 + 0.5 × (N - 1)`，其中 N 為該類別年度累計次數
- **FR-097**: 系統必須依類別獨立計算累計次數：D 類、W 類、O 類、S 類各自獨立累計；**R 類特殊規則** ⭐ **P1 明確化**：**僅 R02/R03/R04/R05 合併計算**累計次數（因都屬人為疏失異常處理）。系統必須使用明確的群組判定邏輯（如 `R_CUMULATIVE_GROUP = {'R02', 'R03', 'R04', 'R05'}`），而非僅依賴 `category='R'`，避免未來新增的 R 類項目（如 R01、R06）被錯誤納入合併計算
- **FR-098**: 系統必須自動統計員工該類別的年度累計次數，透過 `cumulative_counters` 資料表記錄（員工 ID + 年度 + 類別 → 累計次數）
- **FR-099**: 系統必須在建立考核記錄時：(1) 查詢該員工該類別當年累計次數，(2) 判定此次為第 N 次，(3) 計算累計倍率，(4) 計算最終扣分，(5) 更新累計次數 +1
- **FR-100**: 系統必須排除不適用累計加重的項目（has_cumulative = false），這些項目的累計倍率固定為 1.0
- **FR-101**: 系統必須在刪除或修改考核記錄後，自動重算該員工該年度該類別的所有累計次數。**交易機制**：重算邏輯必須包裹在資料庫 Transaction 中，流程為：(1) BEGIN TRANSACTION, (2) 鎖定該員工該年度該類別所有記錄（FOR UPDATE）, (3) 依 event_date 排序, (4) 重新計算累計次數與加重分數, (5) 批次更新所有記錄, (6) 更新 cumulative_counters, (7) COMMIT。確保並發安全性，避免 Race Condition

##### R02-R05 雙因子評分機制 ⭐ **核心新增**

- **FR-102**: 系統必須支援 R02-R05 雙因子評分機制：`實際扣分 = 基本分（依延誤時間） × 責任係數（依疏失程度）`，`最終扣分 = 實際扣分 × 累計倍率`
- **FR-103**: 系統必須提供 9 項疏失查核表介面，項目為：(1) 察覺過晚或誤判、(2) 通報延遲或不完整、(3) 不熟悉故障排除程序、(4) 故障排除決策/操作錯誤、(5) 動作遲緩、(6) 未確認結果或誤認完成、(7) 未主動回報處理進度、(8) 重複性錯誤、(9) 心理狀態影響表現
- **FR-104**: 系統必須根據疏失項數自動判定責任程度：7 項以上 → 完全責任（係數 ×1.0）、4-6 項 → 主要責任（係數 ×0.7）、1-3 項 → 次要責任（係數 ×0.3）
- **FR-105**: 系統必須將責任判定資料儲存至 `fault_responsibility_assessments` 資料表，包含：延誤秒數、9 項查核結果（JSON）、疏失項數、責任程度、責任係數
- **FR-106**: 系統必須在查詢 R02-R05 考核記錄時，一併顯示責任判定詳細資料（疏失項數、責任程度、計算過程）

##### 履歷系統整合 - R02-R05 自動觸發責任判定 ⭐ **特別新增**

- **FR-107**: 系統必須在履歷建立流程中，**自動偵測考核項目是否為 R02/R03/R04/R05**，若是則自動嵌入「責任判定查核表」區塊
- **FR-108**: 責任判定查核表區塊必須包含：
  - 時間節點記錄欄位（T0 事件發生、T1 察覺異常、T2 開始處理、T3 故障排除完成、T4 恢復運轉）
  - 延誤秒數欄位（自動計算 T4-T0，或手動輸入）
  - 9 項疏失查核項目（checkbox，前端顯示完整說明）
- **FR-109**: 系統必須在儲存履歷時，**同時建立三筆記錄**：
  - `Profile`（履歷基本資料）
  - `AssessmentRecord`（考核記錄，含累計倍率與最終扣分）
  - `FaultResponsibilityAssessment`（責任判定詳細資料）
- **FR-110**: 系統必須在產生 Word 文件（事件調查表）時，**自動包含責任判定結果**：責任程度、疏失項數、計算過程、9 項查核明細
- **FR-111**: 系統必須支援修改責任判定結果（重新勾選疏失項目），修改後自動重新計算責任係數、實際扣分、最終扣分，並更新 `assessment_records` 和 `fault_responsibility_assessments`
- **FR-112**: 系統必須確保非 R02-R05 的考核項目**不顯示**責任判定查核表區塊，一般項目僅需選擇考核代碼即可

##### 月度獎勵自動計算 ⭐ **核心新增**

- **FR-113**: 系統必須提供月度獎勵計算排程（每月 1 日凌晨執行），掃描所有員工上個月的考核記錄
- **FR-114**: 系統必須自動判定 +M02 月度行車零違規（條件：當月 R 類、S 類無任何扣分），符合則自動建立 +1 分加分記錄
- **FR-115**: 系統必須自動判定 +M03 月度全項目零違規（條件：當月所有類別 D/W/O/S/R 皆無扣分），符合則自動建立 +2 分加分記錄
- **FR-116**: 系統必須支援 +M02 與 +M03 疊加（當月全項目零違規時，同時發放 +M02 +1 分 + +M03 +2 分 = +3 分）
- **FR-117**: 系統必須將月度獎勵記錄儲存至 `monthly_rewards` 資料表，包含：員工 ID、年月、full_attendance（+M01，另外處理）、driving_zero_violation（+M02）、all_zero_violation（+M03）、total_points（當月獎勵合計）
- **FR-118**: 系統必須確保每位員工每月僅有一筆月度獎勵記錄（透過 UNIQUE 約束：employee_id + year_month）

##### 年度重置機制 ⭐ **核心新增**

- **FR-119**: 系統必須提供年度重置排程（每年 1/1 凌晨執行），執行以下操作：
  - 所有員工的 `current_score` 欄位重設為 80 分
  - 所有 `cumulative_counters` 記錄的 `count` 欄位重設為 0
  - 歷史記錄（`assessment_records`、`fault_responsibility_assessments`、`monthly_rewards`）保留不刪除
- **FR-120**: 系統必須支援手動觸發年度重置功能（管理員權限，提供確認機制防止誤操作）

##### 履歷日期變更的連動重算 ⭐ **P1 新增（Gemini Review 建議）**

- **FR-121**: 系統必須在履歷的 `event_date` 變更時，**自動觸發關聯考核記錄的日期更新**（同步更新 `AssessmentRecord.record_date`）
- **FR-122**: 系統必須在考核記錄日期變更後，**自動重算該員工該年度該類別的所有累計次數**（依 record_date 排序重新計算累計倍率與最終分數）
- **FR-123**: 系統必須在日期**跨年變更**時（如 2026-12-31 → 2027-01-05），**同時重算兩個年度**的累計次數（舊年度與新年度）
- **FR-124**: 系統必須在重算流程中使用**資料庫 Transaction + FOR UPDATE 鎖定**，防止並發修改導致的累計次數錯誤
- **FR-125**: 系統必須在日期變更完成後，**重新計算員工總分**（`Employee.current_score`），確保總分與所有記錄的 final_points 總和一致

##### 查詢與報表

- **FR-126**: 系統必須支援查詢員工年度考核摘要，顯示：當前總分、各類別累計次數（D/W/O/S/R）、所有考核記錄（時間、項目、基本分、責任係數、累計倍率、最終分數）
- **FR-127**: 系統必須支援查詢員工月度獎勵統計（依年月查詢，顯示 +M02、+M03 發放記錄）
- **FR-128**: 系統必須支援匯出考核月報表（排名 + 簽章欄位 + 考核明細），總分相同時排名並列（跳號）
- **FR-129**: 系統必須支援查詢 R02-R05 責任判定統計（依責任程度分類統計：完全責任 X 次、主要責任 Y 次、次要責任 Z 次）

#### 差勤加分自動處理（User Story 10）⭐ **(更新：整合 Phase 12 月度獎勵)**

##### 班表解析與出勤加分（+A 系列）

- **FR-130**: 系統必須提供差勤加分處理功能，可選擇年月和部門，執行月度差勤計算
- **FR-131**: 系統必須從 Google Sheets 班表讀取指定月份資料，支援淡海與安坑兩種班表格式
- **FR-132**: 系統必須自動判斷以下差勤加分項目，建立對應的 AssessmentRecord（而非 Profile）：
  - **+A01 R班出勤**：判斷 `R/...` 格式（+3 分/次）
  - **+A02 國定假日出勤**：判斷 `R(國)/...` 格式（+1 分/次，與 +A01 可疊加）
  - **+A03~+A06 延長工時**：判斷 `(+1)`~`(+4)` 格式（+0.5~+2.0 分）
- **FR-133**: 系統必須支援容錯處理：解析前先正規化字串（移除多餘空白、全形符號轉半形），使用正則表達式精確匹配
- **FR-134**: 系統必須支援複合情況處理：
  - `R/0905G(+2)` → 同時建立 +A01（+3）和 +A04（+1）兩筆記錄
  - `R(國)/1425G(+2)` → 同時建立 +A01（+3）、+A02（+1）和 +A04（+1）三筆記錄

##### 全勤判定與月度獎勵整合（+M 系列）⭐ **新增**

- **FR-135**: 系統必須判斷員工月度全勤條件：當月班表所有儲存格都不包含「(假)」字樣
- **FR-136**: 系統必須在 +A 系列處理完成後，呼叫 Phase 12 MonthlyRewardCalculatorService，傳入全勤狀態
- **FR-137**: Phase 12 MonthlyRewardCalculatorService 必須能夠建立 +M 系列的 AssessmentRecord（不僅是更新 MonthlyReward 總表）：
  - **+M01 月度全勤**：若 is_full_attendance=True，建立 +3 分記錄
  - **+M02 月度行車零違規**：若當月 R+S 類無扣分，建立 +1 分記錄
  - **+M03 月度全項目零違規**：若當月 D/W/O/S/R 類皆無扣分，建立 +2 分記錄
- **FR-138**: 系統必須確保 +M02 和 +M03 可疊加（最高每月 +3 分）

##### 防重複與交易處理

- **FR-139**: 系統必須在資料庫層級防止重複建立：使用 UNIQUE(employee_id, record_date, standard_code) 約束
- **FR-140**: 系統必須在整個月結流程中使用單一 Transaction，確保原子性（失敗時全部回滾）
- **FR-141**: 系統必須支援「預覽模式」：顯示將建立的記錄但不實際寫入，供管理員確認

##### 處理結果與統計

- **FR-142**: 系統必須在處理完成後顯示完整統計結果：
  - 全勤(+M01) X 筆
  - 行車零違規(+M02) Y 筆
  - 全項目零違規(+M03) Z 筆
  - R班出勤(+A01) A 筆
  - 國定假日出勤(+A02) B 筆
  - 延長工時(+A03~06) C 筆
  - 跳過 N 筆（已存在）
- **FR-143**: 系統必須將自動建立的考核記錄標記 description 為「系統自動產生」
- **FR-144**: 系統必須記錄每次處理的歷史紀錄（處理時間、操作人員、統計結果）

#### 未結案管理系統（User Story 11）⭐ **(新增)**

- **FR-145**: 系統必須在履歷轉換為特定類型且產生文件後，將 `Profile.conversion_status` 設定為「converted」
- **FR-146**: 系統必須提供未結案列表，查詢條件為 `conversion_status = 'converted' AND gdrive_link IS NULL`，按類型分類顯示，使用複合索引 `(conversion_status, department)` 提升查詢效能
- **FR-147**: 系統必須顯示每筆未結案記錄的：事件日期、員工姓名、履歷類型、建立日期、檔案路徑
- **FR-148**: 系統必須支援從未結案列表直接上傳 PDF 到 Google Drive
- **FR-149**: 系統必須在 PDF 上傳成功後，更新 `Profile.gdrive_link` 並將 `conversion_status` 更新為「completed」，履歷自動從未結案列表消失
- **FR-150**: 系統必須顯示未結案統計資訊（各類型待處理數量、最舊未結案日期、本月完成率），透過 `Profile` 表統計 `conversion_status = 'converted'` 的記錄
- **FR-151**: 系統必須在上傳失敗時保持 `conversion_status = 'converted'`，記錄保留在未結案列表中並允許重新上傳

#### 駕駛時數統計強化（User Story 5 擴充）⭐ **(新增)**

- **FR-152**: 系統必須支援即時計算指定日期的駕駛時數統計（不儲存）
- **FR-153**: 系統必須支援處理單一日期並儲存到 `driving_daily_stats`
- **FR-154**: 系統必須支援批次處理日期範圍（限制 31 天）
- **FR-155**: 系統必須支援自動補齊缺失日期（從最後處理日期到昨天）
- **FR-156**: 系統必須支援查詢最後處理日期
- **FR-157**: 系統必須支援月度彙總統計（按總駕駛分鐘數排序）
- **FR-158**: 系統必須支援定時任務管理 API（查看排程、手動觸發）
- **FR-126**: 系統必須在 `driving_daily_stats` 記錄當日責任事件次數（R+S 類扣分）

### Database Configuration ⭐ **(新增)**

#### 連線資訊

系統使用 **TiDB Serverless** 作為雲端共享資料庫，相容 MySQL 8.0 協議。

**連線參數**：
```python
DATABASE_CONFIG = {
    'host': 'gateway01.ap-northeast-1.prod.aws.tidbcloud.com',
    'port': 4000,
    'user': '3SQWVrWh5DieHsr.root',
    'password': 'pA6LsowKCFAVVJm2',  # ⚠️ 需環境變數保護
    'database': 'test',
    'charset': 'utf8mb4',
    'ssl_verify_cert': True,
    'ssl_verify_identity': True
}
```

**資料庫版本**：TiDB v7.5.6-serverless (相容 MySQL 8.0.11)

#### Python 連線套件

系統使用 `pymysql` 作為主要資料庫連線驅動。

**安裝指令**：
```bash
pip install pymysql
```

**連線範例**：
```python
import pymysql
from contextlib import contextmanager

@contextmanager
def get_db_connection():
    """取得資料庫連線（Context Manager）"""
    connection = pymysql.connect(
        host='gateway01.ap-northeast-1.prod.aws.tidbcloud.com',
        port=4000,
        user='3SQWVrWh5DieHsr.root',
        password=os.getenv('TIDB_PASSWORD'),  # 從環境變數讀取
        database='test',
        charset='utf8mb4',
        ssl_verify_cert=True,
        ssl_verify_identity=True,
        cursorclass=pymysql.cursors.DictCursor  # 回傳字典格式
    )
    try:
        yield connection
        connection.commit()
    except Exception:
        connection.rollback()
        raise
    finally:
        connection.close()

# 使用範例
with get_db_connection() as conn:
    with conn.cursor() as cursor:
        cursor.execute("SELECT * FROM employees")
        results = cursor.fetchall()
```

#### 環境變數設定

**必要環境變數**（存放於 `.env` 檔案）：

```env
# TiDB 資料庫連線
TIDB_HOST=gateway01.ap-northeast-1.prod.aws.tidbcloud.com
TIDB_PORT=4000
TIDB_USER=3SQWVrWh5DieHsr.root
TIDB_PASSWORD=pA6LsowKCFAVVJm2
TIDB_DATABASE=test

# FastAPI 設定
API_SECRET_KEY=<隨機生成的密鑰>
API_ENVIRONMENT=production  # development / production
```

**安全性規範**：
- ❌ **禁止將 `.env` 檔案提交到版控系統**
- ✅ `.gitignore` 必須包含 `.env`
- ✅ 提供 `.env.example` 作為範本（密碼留空）
- ✅ Render 部署時使用平台的環境變數設定功能

#### 連線池設定（FastAPI）

FastAPI 應用程式應使用連線池提升效能。

**使用 SQLAlchemy（建議）**：
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import QueuePool

# 建立連線字串（使用環境變數）
DATABASE_URL = (
    f"mysql+pymysql://{os.getenv('TIDB_USER')}:{os.getenv('TIDB_PASSWORD')}"
    f"@{os.getenv('TIDB_HOST')}:{os.getenv('TIDB_PORT')}/{os.getenv('TIDB_DATABASE')}"
    f"?charset=utf8mb4&ssl_verify_cert=true&ssl_verify_identity=true"
)

# 建立引擎（連線池）
engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=5,           # 常駐連線數
    max_overflow=10,       # 最大額外連線數
    pool_pre_ping=True,    # 自動檢測斷線
    pool_recycle=3600,     # 1小時回收連線
    echo=False             # 開發時可設為 True 顯示 SQL
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

#### 資料庫初始化

**初始化腳本位置**：`scripts/init_database.py`

**執行順序**：
1. 建立資料表（使用 SQLAlchemy ORM 或原始 SQL）
2. 建立索引（加速查詢）
3. 插入預設資料（管理員帳號、系統設定）
4. （可選）匯入歷史資料（從前專案 SQLite，待確認 PC-005）

**索引建議**：
```sql
-- 員工資料
CREATE INDEX idx_employee_id ON employees(employee_id);
CREATE INDEX idx_department ON employees(current_department);
CREATE INDEX idx_is_resigned ON employees(is_resigned);

-- 勤務標準時間
CREATE INDEX idx_route_department ON route_standard_times(department);
CREATE INDEX idx_route_code ON route_standard_times(department, route_code);
CREATE INDEX idx_route_active ON route_standard_times(is_active);

-- 駕駛時數
CREATE INDEX idx_driving_date ON driving_daily_stats(record_date);
CREATE INDEX idx_driving_employee_date ON driving_daily_stats(employee_id, record_date);
CREATE INDEX idx_driving_fiscal ON driving_daily_stats(fiscal_year, fiscal_month);

-- 駕駛競賽
CREATE INDEX idx_competition_period ON driving_competition(competition_year, competition_month);
CREATE INDEX idx_competition_employee ON driving_competition(employee_id);
```

#### 儲存空間監控

**TiDB 免費版限制**：
- 儲存空間：5 GB
- 連線數：5000 個/天
- Request Units (RU)：50M RU/月

**監控策略**：
- 每日定時檢查資料庫大小（FastAPI 定時任務）
- 當用量達 4 GB（80%）時發送警告通知
- 提供資料清理建議（舊資料歸檔、日誌清理）
- 監控腳本範例：

```python
def check_database_size():
    """檢查資料庫大小"""
    with get_db_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute("""
                SELECT
                    table_schema AS 'database',
                    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'size_mb'
                FROM information_schema.TABLES
                WHERE table_schema = %s
                GROUP BY table_schema
            """, (os.getenv('TIDB_DATABASE'),))
            result = cursor.fetchone()
            size_mb = result['size_mb']

            # 警告門檻：4 GB = 4096 MB
            if size_mb > 4096:
                send_alert(f"資料庫用量已達 {size_mb} MB，接近 5GB 限制！")

            return size_mb
```

#### 備份策略

**自動備份**：
- 每日凌晨 4:00 執行備份（FastAPI 定時任務）
- 備份方式：mysqldump 匯出 SQL（透過 TiDB Cloud 管理介面或 CLI）
- 備份儲存：Google Drive 或本機備份資料夾
- 保留策略：最近 7 天每日備份 + 最近 4 週每週備份

**手動備份**：
```bash
# 使用 mysqldump（需安裝 MySQL Client）
mysqldump -h gateway01.ap-northeast-1.prod.aws.tidbcloud.com \
  -P 4000 \
  -u 3SQWVrWh5DieHsr.root \
  -p \
  --ssl-mode=VERIFY_IDENTITY \
  --databases test \
  > backup_$(date +%Y%m%d).sql
```

#### 連線測試

系統必須提供資料庫連線測試功能（健康檢查端點）。

**FastAPI 健康檢查端點**：
```python
from fastapi import APIRouter, HTTPException

router = APIRouter()

@router.get("/health")
async def health_check():
    """健康檢查端點（用於 UptimeRobot）"""
    try:
        with get_db_connection() as conn:
            with conn.cursor() as cursor:
                cursor.execute("SELECT 1")
                cursor.fetchone()

        return {
            "status": "healthy",
            "database": "connected",
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        raise HTTPException(status_code=503, detail=f"Database connection failed: {str(e)}")

@router.get("/health/database")
async def database_detailed_check():
    """詳細資料庫狀態檢查"""
    try:
        with get_db_connection() as conn:
            with conn.cursor() as cursor:
                cursor.execute("SELECT VERSION()")
                version = cursor.fetchone()

                cursor.execute("SELECT DATABASE()")
                database = cursor.fetchone()

                cursor.execute("SHOW TABLES")
                tables = cursor.fetchall()

        return {
            "status": "connected",
            "version": version['VERSION()'],
            "database": database['DATABASE()'],
            "tables_count": len(tables),
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "timestamp": datetime.now().isoformat()
        }
```

#### 相關功能需求

- **FR-003**: 系統必須使用 TiDB MySQL 作為雲端共享資料庫（已確認）
- **FR-059**: 系統必須使用環境變數儲存資料庫敏感資訊 ⭐ **(新增)**
- **FR-060**: FastAPI 必須實作資料庫連線池，常駐連線數 5，最大連線數 15 ⭐ **(新增)**
- **FR-061**: 系統必須提供 `/health` 端點供 UptimeRobot 監控（已包含資料庫連線測試）
- **FR-062**: 系統必須每日監控資料庫儲存用量，達 80% 時發出警告 ⭐ **(新增)**
- **FR-063**: 系統必須每日凌晨 4:00 自動備份資料庫到 Google Drive ⭐ **(新增)**
- **FR-064**: 網頁應用啟動時必須測試雲端 API 與資料庫連線，失敗時顯示明確錯誤訊息 ⭐ **(新增)**

#### 成功標準

- **SC-015**: 資料庫連線池命中率 > 90%，減少連線建立開銷 ⭐ **(新增)**
- **SC-016**: 資料庫健康檢查響應時間 < 500ms ⭐ **(新增)**
- **SC-017**: 資料庫儲存用量在 2 年內不超過 4.5 GB ⭐ **(新增)**
- **SC-018**: 自動備份成功率 > 99% ⭐ **(新增)**

---

## Non-Functional Requirements ⭐ **(新增)**

### 認證與授權

#### JWT 認證機制規範

**Token 結構**：
- Payload 包含欄位：`user_id`, `role`, `department`, `exp` (過期時間), `iat` (發行時間)
- 簽章演算法：HS256
- Secret Key：使用環境變數 `API_SECRET_KEY`（最少 32 字元）

**有效期限**：
- **NFR-001**: JWT Token 有效期限為 24 小時（從發行時間起算）
- 使用者登入成功後，系統發行 Token，24 小時內無需重新登入

**過期處理**：
- **NFR-002**: Token 過期時，前端必須自動重導向至登入頁面
- **NFR-003**: 登入頁面顯示提示訊息：「登入已逾時，請重新登入」
- **NFR-004**: API 回傳 401 Unauthorized 時，前端 Axios 攔截器統一處理重導向邏輯

**安全規範**：
- Token 儲存於瀏覽器 localStorage
- 每次 API 請求必須在 Header 攜帶 `Authorization: Bearer <token>`
- 後端中間件驗證 Token 有效性（簽章、過期時間、必要欄位）

---

### 前端健康檢查與連線監控

#### 本機桌面應用連線檢測策略

**檢測機制**：
- **NFR-005**: 網頁應用啟動時立即檢測本機 API（http://localhost:8000/health）
- **NFR-006**: HTTP 請求超時時間設定為 3 秒
- **NFR-007**: 背景輪詢頻率為 60 秒（運行中每分鐘檢測一次）
- **NFR-008**: 連續 3 次檢測失敗後，將本機 API 狀態標記為「不可用」
- **NFR-009**: 即使標記為不可用，仍持續輪詢以偵測恢復

**使用者介面**：
- 狀態列持續顯示連線狀態：
  - ✅ 本機應用：已連線
  - ❌ 本機應用：未連線
  - ⚠️ 本機應用：連線中...
- 本機 API 不可用時，所有檔案功能按鈕自動禁用（灰色）
- 不使用彈窗提示（避免打擾使用者）

---

### 安全與金鑰管理

#### 加密金鑰管理策略

**ENCRYPTION_KEY 生命週期**：
- 金鑰在專案生命週期內固定不變
- 不實作自動輪替機制（內部系統，使用者規模小，輪替優先級低）
- 僅在發生安全事件時進行緊急輪替（手動處理）

**金鑰保護措施**：
- 儲存於 Render 環境變數（平台級加密）
- 僅管理員可存取 Render Dashboard
- 本機金鑰檔案權限設定為 0o600（僅擁有者可讀寫）
- 不記錄於日誌或任何明文檔案
- 使用 Fernet 標準演算法（NIST 認證）

**緊急輪替流程**（安全事件發生時）：
1. 生成新的 ENCRYPTION_KEY
2. 選擇低流量時段（凌晨 4:00）進入維護模式
3. 執行腳本重新加密所有資料
4. 更新 Render 環境變數
5. 重啟服務並驗證
6. 預估停機時間：10-15 分鐘

---

## Credential Management & Security ⭐ **(新增：憑證管理策略)**

系統需使用兩種不同類型的 Google API 憑證，各有不同的儲存與安全需求。

### 憑證類型與用途

#### 1. 服務帳戶憑證（Service Account Credentials）

**用途**：
- 自動同步 Google Sheets（班表、勤務表）
- 背景定時任務執行（無需使用者授權）

**格式**：
- JSON 檔案，包含 `private_key`、`client_email`、`project_id` 等

**權限範圍**：
- `https://www.googleapis.com/auth/spreadsheets.readonly`（唯讀 Sheets）

**風險等級**：🔴 **高風險**
- `private_key` 洩露將導致服務帳戶全面控制權限
- 必須加密儲存，不得明文存在於任何檔案或程式碼中

---

#### 2. OAuth 2.0 使用者憑證（User OAuth Credentials）

**用途**：
- 使用者授權上傳檔案到 Google Drive
- 需使用者互動完成授權流程

**格式**：
- `client_id`、`client_secret`（公開配置）
- `refresh_token`、`access_token`（敏感資料）

**權限範圍**：
- `https://www.googleapis.com/auth/drive.file`（僅限建立/修改應用程式建立的檔案）

**風險等級**：🟡 **中風險**
- `refresh_token` 洩露可持續存取使用者 Drive
- `access_token` 洩露僅短期風險（1小時有效期）

---

### 憑證儲存方案

#### 雲端後端（Render FastAPI）

##### 服務帳戶憑證儲存

**方案**：環境變數（Base64 編碼）

```bash
# Render 環境變數設定
TANHAE_GOOGLE_SERVICE_ACCOUNT_JSON=<Base64 編碼的 JSON 內容>
ANPING_GOOGLE_SERVICE_ACCOUNT_JSON=<Base64 編碼的 JSON 內容>
```

**設定步驟**：
```bash
# 本機準備（DO NOT COMMIT）
base64 -w 0 tanhae-service-account.json > tanhae-encoded.txt

# 透過 Render Dashboard 或 CLI 設定環境變數
render env set TANHAE_GOOGLE_SERVICE_ACCOUNT_JSON="$(cat tanhae-encoded.txt)"
```

**讀取範例**：
```python
import json
import base64
import os

def get_service_account_credentials(department: str) -> dict:
    """從環境變數取得服務帳戶憑證"""
    env_key = f"{department.upper()}_GOOGLE_SERVICE_ACCOUNT_JSON"
    encoded = os.getenv(env_key)

    if not encoded:
        raise ValueError(f"Missing service account for {department}")

    decoded = base64.b64decode(encoded).decode('utf-8')
    return json.loads(decoded)
```

**優點**：
- ✅ 不存在於程式碼或檔案系統
- ✅ Render 平台已加密環境變數
- ✅ 部署時自動載入，無需額外配置步驟

---

##### OAuth 令牌儲存

**方案**：資料庫加密欄位

**資料模型**（新增）：
```python
class GoogleOAuthToken(Base):
    """OAuth 令牌安全儲存表"""
    __tablename__ = "google_oauth_tokens"

    id = Column(Integer, primary_key=True)
    department = Column(Enum('淡海', '安坑'), unique=True, nullable=False)

    # 加密儲存（使用 Fernet 對稱加密）
    encrypted_refresh_token = Column(LargeBinary, nullable=False)
    encrypted_access_token = Column(LargeBinary, nullable=True)

    # 訪問令牌到期時間
    access_token_expires_at = Column(DateTime, nullable=True)

    # 授權使用者資訊
    authorized_user_email = Column(String(100), nullable=True)

    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

**加密工具**：
```python
from cryptography.fernet import Fernet
import os

class TokenEncryption:
    """令牌加密/解密工具"""

    @staticmethod
    def get_cipher():
        key = os.getenv("ENCRYPTION_KEY")
        if not key:
            raise ValueError("ENCRYPTION_KEY not set in environment")
        return Fernet(key.encode())

    @staticmethod
    def encrypt_token(token: str) -> bytes:
        cipher = TokenEncryption.get_cipher()
        return cipher.encrypt(token.encode())

    @staticmethod
    def decrypt_token(encrypted: bytes) -> str:
        cipher = TokenEncryption.get_cipher()
        return cipher.decrypt(encrypted).decode()
```

**環境變數**（必須設定）：
```bash
# 加密金鑰（使用 Fernet.generate_key() 產生）
ENCRYPTION_KEY=<44 字元 Base64 字串>

# OAuth 客戶端配置
GOOGLE_OAUTH_CLIENT_ID=<your-app-id>.apps.googleusercontent.com
GOOGLE_OAUTH_CLIENT_SECRET=<your-client-secret>
GOOGLE_OAUTH_REDIRECT_URI=https://your-app.onrender.com/api/auth/google/callback
```

**產生加密金鑰**：
```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

**優點**：
- ✅ `refresh_token` 加密後儲存於資料庫
- ✅ 即使資料庫洩露，無 `ENCRYPTION_KEY` 無法解密
- ✅ 支援多部門獨立授權

---

#### 本機桌面應用（localhost:8000）

##### OAuth 令牌儲存

**方案**：本機加密檔案

**儲存位置**：`~/.driver_management_system/tokens.encrypted`

**實作範例**：
```python
from pathlib import Path
from cryptography.fernet import Fernet
import json
import os

class DesktopCredentialManager:
    """本機憑證管理器"""

    CONFIG_DIR = Path.home() / ".driver_management_system"
    TOKENS_FILE = CONFIG_DIR / "tokens.encrypted"
    KEY_FILE = CONFIG_DIR / ".key"

    @classmethod
    def save_oauth_token(cls, department: str, refresh_token: str):
        """儲存 OAuth 刷新令牌（加密）"""
        cls.CONFIG_DIR.mkdir(exist_ok=True, mode=0o700)  # 僅擁有者可存取

        # 取得或建立加密金鑰
        key = cls._get_or_create_local_key()
        cipher = Fernet(key)

        # 讀取現有令牌（若存在）
        tokens = {}
        if cls.TOKENS_FILE.exists():
            with open(cls.TOKENS_FILE, 'rb') as f:
                encrypted = f.read()
                tokens = json.loads(cipher.decrypt(encrypted).decode())

        # 更新令牌
        tokens[department] = {
            "refresh_token": refresh_token,
            "created_at": datetime.now().isoformat()
        }

        # 加密後寫入
        with open(cls.TOKENS_FILE, 'wb') as f:
            encrypted = cipher.encrypt(json.dumps(tokens).encode())
            f.write(encrypted)

        # 設定檔案權限（僅擁有者可讀寫）
        os.chmod(cls.TOKENS_FILE, 0o600)

    @classmethod
    def get_oauth_token(cls, department: str) -> str:
        """讀取 OAuth 刷新令牌（解密）"""
        if not cls.TOKENS_FILE.exists():
            raise FileNotFoundError("No tokens found, please authorize first")

        key = cls._get_or_create_local_key()
        cipher = Fernet(key)

        with open(cls.TOKENS_FILE, 'rb') as f:
            encrypted = f.read()
            tokens = json.loads(cipher.decrypt(encrypted).decode())

        if department not in tokens:
            raise ValueError(f"No token for department: {department}")

        return tokens[department]["refresh_token"]

    @classmethod
    def _get_or_create_local_key(cls) -> bytes:
        """取得或建立本機加密金鑰"""
        if cls.KEY_FILE.exists():
            return cls.KEY_FILE.read_bytes()

        # 首次執行時產生
        key = Fernet.generate_key()
        cls.KEY_FILE.write_bytes(key)
        os.chmod(cls.KEY_FILE, 0o600)  # 僅擁有者可讀
        return key
```

**檔案結構**：
```
C:\Users\<username>\.driver_management_system\
├── .key                  # 本機加密金鑰（600 權限）
└── tokens.encrypted      # 加密的 OAuth 令牌（600 權限）
```

**優點**：
- ✅ 令牌不存在於明文檔案
- ✅ 加密金鑰與令牌分離
- ✅ 檔案權限限制防止其他使用者讀取
- ✅ 桌面應用關閉時令牌仍保留（無需重新授權）

---

### 安全規範與檢查清單

#### 🚫 絕對禁止的做法

```python
# ❌ 禁止 1：硬編碼憑證
SERVICE_ACCOUNT = {
    "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBg..."
}

# ❌ 禁止 2：明文儲存在 .env 並提交到 Git
# .env 檔案內容
GOOGLE_SERVICE_ACCOUNT_JSON={"type":"service_account","private_key":"..."}

# ❌ 禁止 3：未加密的資料庫欄位
refresh_token = Column(String(500))  # 明文儲存

# ❌ 禁止 4：將憑證寫入日誌
logger.info(f"Service account: {credentials}")

# ❌ 禁止 5：在 GitHub 中儲存憑證檔案
git add tanhae-service-account.json  # 災難性錯誤
```

---

#### ✅ 必須遵守的安全檢查清單

**開發階段**：
- [ ] `.env` 檔案已加入 `.gitignore`
- [ ] 提供 `.env.example` 範本（密碼留空）
- [ ] 本機測試憑證與正式環境憑證分離
- [ ] 服務帳戶僅授予最小必要權限（唯讀 Sheets）
- [ ] OAuth 應用僅請求必要 scopes（`drive.file`）

**部署階段**：
- [ ] Render 環境變數已設定所有必要憑證
- [ ] `ENCRYPTION_KEY` 已產生並設定（不得重複使用）
- [ ] TiDB 連線使用 SSL/TLS 加密
- [ ] 資料庫備份檔案已加密或限制存取權限

**運行階段**：
- [ ] 定期輪換服務帳戶金鑰（建議每 90 天）
- [ ] 監控異常 API 使用（偵測憑證洩露）
- [ ] 日誌不記錄敏感資訊（token、private_key）
- [ ] OAuth `access_token` 快取時間不超過 55 分鐘

**本機應用**：
- [ ] 加密檔案權限設為 `0o600`（僅擁有者可讀寫）
- [ ] 本機加密金鑰不備份到雲端（風險：金鑰洩露）
- [ ] 解除安裝時提示使用者刪除 `~/.driver_management_system`

---

### OAuth 授權流程設計

#### 初次授權流程（管理員操作）

```mermaid
sequenceDiagram
    participant A as 管理員
    participant W as 網頁應用
    participant C as 雲端 API
    participant G as Google OAuth

    A->>W: 進入「Google 服務設定」
    W->>C: GET /api/google/auth-url?department=淡海
    C->>G: 產生授權 URL（含 state 參數）
    G-->>C: 返回授權 URL
    C-->>W: 返回授權 URL
    W->>A: 顯示「點擊授權 Google Drive」按鈕
    A->>G: 點擊授權（開啟新視窗）
    G->>A: 顯示 Google 授權畫面
    A->>G: 同意授權
    G->>C: 重定向到 /api/auth/google/callback?code=xxx
    C->>G: 用 code 換取 refresh_token
    G-->>C: 返回 refresh_token + access_token
    C->>C: 加密 refresh_token 並儲存到資料庫
    C-->>W: 授權成功
    W->>A: 顯示「✓ Google Drive 已授權（淡海）」
```

#### 檔案上傳時使用令牌

```mermaid
sequenceDiagram
    participant U as 使用者
    participant D as 本機桌面應用
    participant C as 雲端 API
    participant DB as TiDB
    participant G as Google Drive

    U->>D: 點擊「上傳 PDF 到 Drive」
    D->>C: POST /api/google/get-access-token?department=淡海
    C->>DB: 讀取 encrypted_refresh_token
    DB-->>C: 返回加密令牌
    C->>C: 解密 refresh_token
    C->>G: 用 refresh_token 換取 access_token
    G-->>C: 返回 access_token（有效期 1 小時）
    C-->>D: 返回 access_token
    D->>G: 上傳檔案（使用 access_token）
    G-->>D: 上傳成功，返回檔案 URL
    D-->>U: 顯示「✓ 上傳成功」
```

---

### 功能需求更新

#### 憑證管理相關需求

- **FR-065**: 系統必須支援雙部門獨立的 Google 服務帳戶憑證配置 ⭐ **(新增)**
- **FR-066**: 服務帳戶憑證必須儲存於 Render 環境變數，使用 Base64 編碼 ⭐ **(新增)**
- **FR-067**: 系統必須提供加密工具類別（Fernet），加密 OAuth `refresh_token` ⭐ **(新增)**
- **FR-068**: OAuth 令牌必須儲存於資料庫加密欄位（`encrypted_refresh_token`）⭐ **(新增)**
- **FR-069**: 系統必須提供 OAuth 授權流程端點（`/api/google/auth-url`、`/api/auth/google/callback`）⭐ **(新增)**
- **FR-070**: 本機桌面應用必須將 OAuth 令牌加密儲存於 `~/.driver_management_system/tokens.encrypted` ⭐ **(新增)**
- **FR-071**: 加密檔案與金鑰檔案必須設定 `0o600` 權限（僅擁有者可讀寫）⭐ **(新增)**
- **FR-072**: 系統日誌不得記錄任何憑證內容（`private_key`、`refresh_token`、`access_token`）⭐ **(新增)**
- **FR-073**: 系統必須在 `.gitignore` 中排除所有憑證相關檔案（`.env`、`*.json` 服務帳戶憑證）⭐ **(新增)**
- **FR-074**: 系統必須提供憑證健康檢查功能（測試服務帳戶與 OAuth 連線狀態）⭐ **(新增)**

---

### 成功標準更新

- **SC-019**: 服務帳戶憑證不得出現在任何 Git 提交記錄中 ⭐ **(新增)**
- **SC-020**: OAuth 令牌加密/解密效能 < 10ms ⭐ **(新增)**
- **SC-021**: 憑證輪換流程可在 5 分鐘內完成（不影響系統運行）⭐ **(新增)**
- **SC-022**: OAuth 授權流程使用者完成時間 < 2 分鐘 ⭐ **(新增)**
- **SC-023**: 本機加密檔案權限檢查通過率 100%（開發、測試、生產環境）⭐ **(新增)**

---

### Key Entities

#### Employee (員工資料)
```python
- id: Integer (PK)
- employee_id: String(20) (唯一索引)
- employee_name: String(50)
- current_department: Enum('淡海', '安坑')
- hire_year_month: String(7)  # 2026-01
- phone: String(20) (nullable)
- email: String(100) (nullable)
- emergency_contact: String(50) (nullable)
- emergency_phone: String(20) (nullable)
- is_resigned: Boolean
- created_at: DateTime
- updated_at: DateTime
```

#### EmployeeTransfer (員工調動歷史)
```python
- id: Integer (PK)
- employee_id: String(20) (FK → Employee)
- from_department: Enum('淡海', '安坑')
- to_department: Enum('淡海', '安坑')
- transfer_date: Date
- reason: Text (nullable)
- created_by: String(50)
- created_at: DateTime
```

#### User (使用者帳號)
```python
- id: Integer (PK)
- username: String(50) (唯一)
- password_hash: String(255)
- role: Enum('admin', 'staff', 'manager')
- department: Enum('淡海', '安坑', 'all')
- is_active: Boolean
- created_at: DateTime
- updated_at: DateTime
```

#### SystemSetting (系統設定)
```python
- id: Integer (PK)
- key: String(100)
- value: Text
- department: Enum('淡海', '安坑', 'global') (nullable)
- description: String(255)
- created_at: DateTime
- updated_at: DateTime
- UniqueConstraint(key, department)
```

#### GoogleOAuthToken (OAuth 令牌加密儲存) ⭐ **(新增)**
```python
- id: Integer (PK)
- department: Enum('淡海', '安坑') (唯一索引)
- encrypted_refresh_token: LargeBinary (使用 Fernet 加密)
- encrypted_access_token: LargeBinary (nullable, 快取用)
- access_token_expires_at: DateTime (nullable)
- authorized_user_email: String(100) (nullable, 授權者 Email)
- created_at: DateTime
- updated_at: DateTime
```

**說明**：
- `encrypted_refresh_token`：加密後的 Google OAuth refresh_token，用於長期存取 Google Drive
- `encrypted_access_token`：快取的 access_token（選用），避免頻繁刷新
- `access_token_expires_at`：access_token 到期時間，用於判斷是否需要刷新
- `authorized_user_email`：授權的 Google 帳號 Email，便於追蹤與管理
- 加密金鑰儲存於環境變數 `ENCRYPTION_KEY`

#### RouteStandardTime (勤務標準時間) ⭐ **(新增)**
```python
- id: Integer (PK)
- department: Enum('淡海', '安坑')
- route_code: String(50)  # 勤務代碼（如「淡安-全」、「淡海專」）
- route_name: String(100)  # 勤務名稱（如「淡海安坑全程」）
- standard_minutes: Integer  # 標準所需時間（分鐘）
- is_active: Boolean  # 是否啟用
- created_at: DateTime
- updated_at: DateTime
- UniqueConstraint(department, route_code)
```

**說明**：
- 每個部門獨立設定勤務標準時間
- 管理員可透過後台介面編輯（CRUD 操作）
- 駕駛競賽計算時，從此表讀取標準時間
- 支援匯入 Excel 初始資料

#### DrivingDailyStats (每日駕駛時數)
```python
- id: Integer (PK)
- employee_id: String(20)
- employee_name: String(50)
- department: Enum('淡海', '安坑')
- record_date: Date
- total_minutes: Integer
- incident_count: Integer
- fiscal_year: Integer
- fiscal_month: Integer
- created_at: DateTime
- updated_at: DateTime
- UniqueConstraint(employee_id, record_date)
```

#### DrivingCompetition (駕駛競賽排名)
```python
- id: Integer (PK)
- employee_id: String(20)
- employee_name: String(50)
- department: Enum('淡海', '安坑')
- competition_year: Integer
- competition_month: Integer
- total_driving_minutes: Integer
- total_incidents: Integer
- safety_score: Float
- rank_in_department: Integer
- rank_overall: Integer
- created_at: DateTime
- updated_at: DateTime
- UniqueConstraint(employee_id, competition_year, competition_month)
```

#### Profile (履歷主表) ⭐ **(User Story 8 新增)**
```python
- id: Integer (PK)
- version: Integer  # 樂觀鎖版本號，防止並發編輯衝突
- profile_type: Enum('basic', 'event_investigation', 'personnel_interview', 'assessment_notice', 'corrective_measures')
- event_date: Date (必填)
- event_time: String(5)  # HH:MM 格式
- event_title: String(200) (必填)
- employee_id: String(20) (必填)
- employee_name: String(50) (必填, 索引)
- department: Enum('淡海', '安坑')
- event_location: String(100) (索引)
- train_number: String(20) (索引)
- event_description: Text (必填)
- data_source: String(100)  # 資料來源（如「系統自動」、「手動建立」）
- assessment_item: String(200)  # 考核項目代碼（如「[D01] 遲到/早退」）
- assessment_score: Decimal(5,2)
- conversion_status: Enum('pending', 'converted', 'completed')  # 轉換狀態
- file_path: String(500)  # 本機 Office 檔案路徑
- gdrive_link: String(500)  # Google Drive 連結
- created_by: Integer (FK → User.id)
- created_at: DateTime
- updated_at: DateTime
- Index(event_date)
- Index(employee_name)
- Index(event_location)
- Index(train_number)
- Index(conversion_status, department)  # 複合索引，用於未結案查詢
- UniqueConstraint(employee_id, event_date, assessment_item, name='uq_profile_dedup')  # 防止差勤加分重複建立（FR-108）
```

#### EventInvestigation (事件調查) ⭐ **(User Story 8 新增)**
```python
- id: Integer (PK)
- profile_id: Integer (FK → Profile.id, Unique)
- incident_time: DateTime
- incident_location: String(200)
- witness_name: String(100)
- incident_cause: Text  # 事故原因
- incident_process: Text  # 事故經過
- improvement_suggestion: Text  # 改善建議
- investigator: String(50)
- investigation_date: Date
- created_at: DateTime
- updated_at: DateTime
```

#### PersonnelInterview (人員訪談) ⭐ **(User Story 8 新增)**
```python
- id: Integer (PK)
- profile_id: Integer (FK → Profile.id, Unique)
- interview_date: Date
- interviewer: String(50)
- incident_cause: Text  # 事故經過（與 EventInvestigation 共用欄位名稱）
- interview_content: Text  # 訪談記錄
- interview_result: Text  # 訪談結果（多選，逗號分隔）
- interview_result_other: String(200)  # 訪談結果-其他
- follow_up_actions: Text  # 追蹤辦理事項（多選，逗號分隔）
- follow_up_actions_other: String(200)  # 追蹤辦理事項-其他
- conclusion: Text  # 值班人員建議
# 自動帶入欄位（從員工編號與 Google Sheets 班表取得）
- hire_date: String(10)  # 到職日期（如 2021/11）
- shift1: String(50)  # 事件當天班別
- shift2: String(50)  # 事件前一天班別
- shift3: String(50)  # 事件前兩天班別
- created_at: DateTime
- updated_at: DateTime
```

#### CorrectiveMeasures (矯正措施) ⭐ **(User Story 8 新增)**
```python
- id: Integer (PK)
- profile_id: Integer (FK → Profile.id, Unique)
- incident_cause: Text  # 事件概述
- corrective_action: Text  # 矯正措施
- created_at: DateTime
- updated_at: DateTime
```

#### AssessmentNotice (考核加扣分通知單) ⭐ **(User Story 8 新增)**
```python
- id: Integer (PK)
- profile_id: Integer (FK → Profile.id, Unique)
- notice_type: Enum('addition', 'deduction')  # 加分/扣分
- reason: Text
- issuer: String(50)
- issue_date: Date
- created_at: DateTime
- updated_at: DateTime
```

#### AssessmentStandard (考核標準表) ⭐ **(User Story 9 新增)**
```python
- id: Integer (PK)
- item_name: String(200) (必填)  # 考核項目名稱
- category: Enum('addition', 'deduction')  # 加分/扣分
- base_score: Decimal(5,2) (必填)  # 基本分數
- description: Text
- version: String(20) (必填)  # 版本號（v1, v2）
- effective_date: Date (必填)  # 生效日期
# V2 新增欄位（2026年起）
- code: String(10)  # 項目代碼（如 D01, +M01）
- category_code: String(5)  # 類別代碼（如 D, W, O, S, R, +M, +A, +B, +C, +R）
- unit: String(10)  # 計分單位（每次、每月、每趟）
- is_accumulation_applicable: Boolean  # 是否適用累計加重（預設 True）
- custom_notes: Text  # 手寫備註（支援關鍵字搜尋，上限 500 字元）
- created_at: DateTime
- updated_at: DateTime
- Index(item_name)
- Index(category)
- Index(code)
- Index(category_code)
```

**說明**：
- V1 版本（2025 年含以前）：使用 item_name, category, base_score, description, version, effective_date
- V2 版本（2026 年起）：額外使用 code, category_code, unit, is_accumulation_applicable, custom_notes
- 不適用累計加重的項目：D05（曠職）、W04/W05/W07、S12/S13/S16（重大違規）

#### AssessmentRecord (考核記錄) ⭐ **(User Story 9 新增)**
```python
- id: Integer (PK)
- profile_id: Integer (FK → Profile.id)
- employee_id: String(20) (必填)
- employee_name: String(50) (必填)
- item_id: Integer (FK → AssessmentStandard.id)
- base_score: Decimal(5,2) (必填)  # 基本分數
- weighted_score: Decimal(5,2) (必填)  # 實際分數（含加重）
- occurrence_count: Integer (必填)  # 累計次數（年度內）
- fiscal_year: Integer (必填)
# V2 新增欄位（2026年起）
- accumulation_multiplier: Decimal(4,2)  # 累計加重倍率（如 1.0, 1.5, 2.0）
- condition_flags: Text  # 條件加重標記（JSON 格式）
- remarks: Text  # 備註說明
- occurred_at: DateTime  # 發生日期時間
- created_by: String(50)
- deleted_at: DateTime  # 軟刪除時間
- created_at: DateTime
- updated_at: DateTime
- Index(employee_id)
- Index(fiscal_year)
- Index(employee_id, fiscal_year)  # 複合索引
- Index(occurred_at)
```

**累計加重公式**：
```
實際扣分 = 基本分 × [1 + 係數 × (第N次 - 1)]
係數 = 0.5（可在系統設定調整）

範例（D 類違規）：
- 第 1 次：-1 × 1.0 = -1 分
- 第 2 次：-1 × 1.5 = -1.5 分
- 第 3 次：-1 × 2.0 = -2 分
```

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理員能在 10 分鐘內完成雙部門的 Google 服務配置
- **SC-002**: 員工資料 CRUD 操作響應時間 < 1 秒
- **SC-003**: 權限檢查正確率達 100%（無越權操作）
- **SC-004**: 班表與勤務表同步成功率 > 99%（排除網路問題）
- **SC-005**: 定時任務執行準時率 > 99%（誤差 < 1 分鐘）
- **SC-006**: PDF 條碼識別與部門判斷正確率達 100%
- **SC-007**: 駕駛競賽排名計算準確率達 100%（與手動計算一致）
- **SC-008**: 系統在 Render 的運行時間達 24/7（UptimeRobot 監控）
- **SC-009**: TiDB 資料庫用量監控，提前 20% 發出警告
- **SC-010**: 網頁應用首次載入時間 < 3 秒
- **SC-011**: 桌面應用啟動時間 < 5 秒
- **SC-012**: 憑證驗證測試完成時間 < 5 秒 ⭐ **(新增)**
- **SC-013**: 連線狀態檢測延遲 < 1 秒 ⭐ **(新增)**
- **SC-014**: 手動同步功能可在管理員發起後 3 秒內開始執行 ⭐ **(新增)**
- **SC-015a**: 本地快取（若實作）命中率 > 80%，減少 API 請求 50% ⭐ **(新增)**
- **SC-015b**: 桌面應用不可用時，核心功能（資料瀏覽、履歷建立）仍能正常運作 ⭐ **(容錯設計)**
- **SC-015c**: 桌面應用檔案處理 API 響應時間 < 3 秒（Word生成、條碼生成）⭐ **(新增)**

### Assumptions

#### 資料與服務
- 淡海與安坑的考核標準表相同（V1 與 V2）
- Google Sheets API 配額足夠每日同步使用
- TiDB 免費版 5GB 儲存空間足夠 2 年使用
- Render 免費版 750 小時/月額度足夠 24/7 運行
- 員工編號格式保持一致（YYMMM0XXX）
- 駕駛競賽方案在年度內不變更規則
- 安坑班表結構與淡海相似，差異可在 Phase 3 處理
- 使用者同時在線人數 < 10 人
- 網路連線穩定，Google API 可用性 > 99%

#### 架構與使用環境 ⭐ **(新增)**
- 使用者瀏覽器支援現代 JavaScript（ES6+）與 HTTPS
- 使用者裝置為 Windows 作業系統（桌面應用僅支援 Windows）
- 檔案生成功能使用頻率較低（每日 < 50 次），可接受需啟動桌面應用
- 使用者可存取 GitHub Pages（https://username.github.io），無企業防火牆限制
- 本機桌面應用 API（localhost:8000）不會與其他本機服務衝突
- 核心功能（資料瀏覽、履歷建立）使用頻率高，必須隨時可用

## Implementation Phases

### Phase 0: 基礎架構 (估計 10-14 天) ⭐ **(架構調整)**
- 建立專案結構（前端 + 雲端 API + 本機 API）
  - 前端：GitHub Pages（Vue.js/React）專案初始化
  - 雲端後端：FastAPI 專案結構（Render）
  - 本機後端：FastAPI 本機 API（桌面應用）
- 設定 TiDB 資料庫連接與連線池
- 實作使用者認證與權限中間件（JWT）
- 建立基礎資料模型（Employee, User, SystemSetting, GoogleOAuthToken）⭐ **(已更新)**
- **憑證管理系統**（環境變數讀取、加密工具類別）⭐ **(新增)**
  - 實作 `TokenEncryption` 類別（Fernet 加密/解密）
  - 實作服務帳戶憑證載入（Base64 解碼）
  - 建立 `.env.example` 範本與 `.gitignore` 規則
- **前端連線狀態檢測功能**（檢測雲端 API 與本機 API）⭐ **(新增)**
- **本機 API CORS 設定**（允許 GitHub Pages 跨域請求）⭐ **(新增)**
- **本機憑證管理器**（OAuth 令牌加密檔案存儲）⭐ **(新增)**
- 部署雲端 FastAPI 到 Render
- 部署前端到 GitHub Pages
- 設定 UptimeRobot 監控
- 開發歷史資料遷移腳本（`scripts/migrate_from_sqlite.py`）

### Phase 1: 員工管理模組 (估計 10-14 天) ⭐ **(架構調整)**
- 雲端 API：員工資料 CRUD 端點
- 雲端 API：員工調動記錄功能
- 雲端 API：員工編號解析入職年月
- 雲端 API：批次匯入/匯出功能
- 權限控制實作（API 中間件）
- **前端網頁介面**（員工列表、詳情、編輯表單）⭐ **(網頁應用)**
- **前端路由設定**（Vue Router / React Router）⭐ **(網頁應用)**
- **前端狀態管理**（Pinia / Redux）⭐ **(網頁應用)**

### Phase 2: Google 服務整合 (估計 12-16 天) ⭐ **(時程已調整)**
- Google 服務管理器（多憑證支援）
- **OAuth 授權流程實作** ⭐ **(新增)**
  - 實作 `/api/google/auth-url` 端點（產生授權 URL）
  - 實作 `/api/auth/google/callback` 端點（接收授權碼）
  - 實作 `/api/google/get-access-token` 端點（令牌刷新）
  - OAuth 令牌加密存儲與讀取
- 系統設定介面（部門配置）
- **憑證驗證功能（Dry Run）** ⭐ **(新增)**
- 班表同步模組（淡海，使用前專案邏輯）
- **手動同步功能與進度顯示** ⭐ **(新增)**
- 勤務表同步模組（待釐清結構後實作）
- 駕駛時數統計
- 定時任務設定

### Phase 3: 安坑模組適配 (估計 5-7 天)
- 安坑班表結構解析（待釐清）
- 安坑勤務表同步
- 雙部門測試

### Phase 4: 駕駛競賽模組 (估計 7-10 天)
- 勤務標準時間管理功能（後台 CRUD + Excel 匯入）
- 駕駛競賽計算邏輯（最終積分公式已確認，見 PC-001）
- 月度排名自動計算（部門排名 + 全公司排名）
- 競賽報表產出
- 前端介面（勤務標準時間管理、競賽排名顯示）

### Phase 5: 本機 API 檔案處理功能 (估計 10-14 天) ⭐ **(架構調整)**
- **本機 API：Word 文件生成端點**（`POST /api/generate-word`）⭐ **(新增)**
- **本機 API：條碼生成端點**（`POST /api/generate-barcode`，加入部門前綴）⭐ **(新增)**
- **本機 API：PDF 掃描與切分**（條碼識別、部門判斷）
- **本機 API：Google Drive 上傳端點**（`POST /api/upload-to-drive`）⭐ **(新增)**
- 多部門 Google Drive 憑證管理
- **前端網頁：檔案生成功能按鈕**（檢測本機 API 可用性）⭐ **(容錯設計)**
- **前端網頁：檔案生成進度顯示**（Word、PDF、條碼）⭐ **(新增)**
- 桌面應用托盤程式開發（啟動/停止本機 API）

### Phase 6: 報表與主管功能 (估計 5-7 天)
- 主管角色權限實作
- 各類報表產出
- 報表匯出功能

### Phase 7: 測試與優化 (估計 7-10 天)
- 整合測試
- 權限測試
- 效能優化
- 使用者驗收測試

**總估計時間：66-92 天（約 3.0-4.1 個月）** ⭐ **(已根據架構調整更新)**

---

## 更新記錄

### v1.4 (2026-01-28) - 憑證管理與安全策略規範

**新增章節**：
- ✅ Credential Management & Security 完整章節
  - 兩種憑證類型說明（服務帳戶、OAuth 2.0）
  - 雲端後端憑證儲存方案（環境變數 + 資料庫加密）
  - 本機應用憑證儲存方案（加密檔案）
  - OAuth 授權流程設計（Sequence Diagram）
  - 安全規範與檢查清單

**新增資料模型**：
- ✅ GoogleOAuthToken 表（OAuth 令牌加密儲存）
  - `encrypted_refresh_token` (LargeBinary)
  - `encrypted_access_token` (LargeBinary, nullable)
  - `access_token_expires_at` (DateTime)
  - `department` (Enum)

**新增功能需求**：
- ✅ FR-065 ~ FR-074：憑證管理相關需求
  - 雙部門獨立憑證配置
  - Base64 編碼服務帳戶憑證
  - Fernet 加密工具類別
  - OAuth 授權流程端點
  - 本機加密檔案存儲
  - 檔案權限控制（0o600）
  - 日誌安全（不記錄憑證）
  - `.gitignore` 規則
  - 憑證健康檢查

**新增成功標準**：
- ✅ SC-019 ~ SC-023：憑證安全相關標準
  - Git 記錄不含憑證
  - 加密效能 < 10ms
  - 憑證輪換 < 5 分鐘
  - OAuth 授權完成 < 2 分鐘
  - 檔案權限檢查 100%

**實作階段更新**：
- ✅ Phase 0：加入憑證管理系統開發
  - TokenEncryption 類別實作
  - 服務帳戶憑證載入
  - 本機憑證管理器
- ✅ Phase 2：加入 OAuth 授權流程實作
  - `/api/google/auth-url` 端點
  - `/api/auth/google/callback` 端點
  - `/api/google/get-access-token` 端點

**技術決策**：
- 加密方案：Fernet (對稱加密)
- 服務帳戶儲存：Render 環境變數（Base64）
- OAuth 令牌儲存：TiDB 加密欄位
- 本機令牌儲存：`~/.driver_management_system/tokens.encrypted`
- 檔案權限：`0o600`（僅擁有者可讀寫）

**安全規範強化**：
- ❌ 禁止硬編碼憑證
- ❌ 禁止明文儲存敏感資訊
- ❌ 禁止將憑證寫入日誌
- ❌ 禁止提交憑證檔案到 Git
- ✅ 必須使用環境變數或加密存儲
- ✅ 必須定期輪換憑證（建議 90 天）

---

### v1.3 (2026-01-28) - 架構調整：混合式三層架構

**架構重大變更**：
- ✅ 從 `PyQt6 桌面應用 + FastAPI 雲端 API` 改為 `GitHub Pages 網頁應用 + Render FastAPI + 本機桌面應用 API`
- ✅ 網頁應用為主要使用者介面，取代 PyQt6 桌面應用
- ✅ 本機桌面應用角色調整為「檔案處理工具」，提供本機 API（localhost:8000）
- ✅ 核心功能（資料瀏覽、履歷建立、員工管理）完全運行於網頁端

**容錯設計新增**：
- ✅ FR-002c：核心功能不依賴桌面應用，桌面應用失敗不影響系統運作
- ✅ FR-002e：桌面應用不可用時，禁用檔案生成功能並提示使用者
- ✅ FR-039、FR-048：檔案功能與核心功能解耦
- ✅ SC-015b：容錯設計成功標準

**前端網頁應用新增**：
- ✅ FR-035 ~ FR-040：網頁應用功能需求
- ✅ GitHub Pages 託管方案確認（免費、支援 SPA、自動部署）
- ✅ CORS 跨域請求處理（本機 API）

**本機桌面應用調整**：
- ✅ FR-041 ~ FR-047：本機 API 功能需求（檔案處理）
- ✅ FR-031 ~ FR-047：Word 生成、PDF 處理、條碼生成、Google Drive 上傳端點
- ✅ 系統托盤程式（啟動/停止 API、狀態顯示）

**實作階段調整**：
- ✅ Phase 0：10-14 天（原 7-10 天，新增前端專案初始化、CORS 設定）
- ✅ Phase 1：10-14 天（原 7-10 天，新增前端網頁介面、路由、狀態管理）
- ✅ Phase 5：10-14 天（原 5-7 天，新增本機 API 端點開發、前端整合）
- ✅ 總時程：66-92 天（約 3.0-4.1 個月）

**技術堆疊調整**：
- 前端：Vue.js 3 / React（GitHub Pages）
- 雲端後端：FastAPI（Render）+ TiDB MySQL
- 本機後端：FastAPI（本機 API）+ Python 檔案處理套件

---

### v1.2 (2026-01-28) - 資料庫連線規格新增

**新增內容：**
1. ✅ Database Configuration 章節：完整資料庫連線配置說明
2. ✅ TiDB 連線資訊與測試結果
3. ✅ 環境變數設定規範（`.env` 檔案）
4. ✅ 連線池設定建議（SQLAlchemy）
5. ✅ 資料庫初始化流程與索引建議
6. ✅ 儲存空間監控策略（5GB 限制管理）
7. ✅ 自動備份策略（每日凌晨 4:00）
8. ✅ 健康檢查端點範例（`/health` 與 `/health/database`）
9. ✅ FR-049 ~ FR-054：資料庫相關功能需求
10. ✅ SC-015 ~ SC-018：資料庫相關成功標準

**技術決策：**
- 資料庫：TiDB v7.5.6-serverless（相容 MySQL 8.0.11）
- Python 驅動：pymysql（支援 SSL/TLS）
- ORM：SQLAlchemy（連線池管理）
- 連線池：5 個常駐連線 + 10 個額外連線

**安全性：**
- 敏感資訊使用環境變數保護
- SSL/TLS 加密連線啟用
- `.env` 檔案加入 `.gitignore`
- 提供 `.env.example` 範本

---

### v1.1 (2026-01-28) - Gemini 審驗建議採納

**新增功能：**
1. ✅ PC-005：歷史資料遷移需求釐清
2. ✅ User Story 4 擴充：手動同步功能與進度顯示
3. ✅ User Story 6（新增）：系統連線狀態監控與憑證驗證
4. ✅ FR-024a ~ FR-024f：手動同步與憑證驗證需求
5. ✅ FR-037a ~ FR-037e：連線狀態顯示需求
6. ✅ FR-041 ~ FR-044：本地快取（可選）
7. ✅ FR-045 ~ FR-048：歷史資料遷移（待確認）
8. ✅ SC-011 ~ SC-014：新增成功標準
9. ✅ 時程調整：Phase 0（+2天）、Phase 2（+2天）

**改進項目：**
- 提升使用者體驗：即時連線狀態回饋
- 降低操作風險：憑證驗證避免配置錯誤
- 增強可靠性：手動同步補救自動排程失敗
- 提升效能：本地快取減少 API 請求

---

**下一步**：
1. 使用者確認規格文件無誤
2. 釐清 Pending Clarifications 中的問題
3. 開始 Phase 0 實作
