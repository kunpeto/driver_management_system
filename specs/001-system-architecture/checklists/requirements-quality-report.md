# 需求質量檢查報告

**檢查日期**: 2026-01-28
**檢查範圍**: Feature 001 - 司機員管理系統整體架構 (spec.md)
**檢查者**: Claude Sonnet 4.5
**檢查方法**: 系統性對照 30 項檢查清單項目

---

## 執行摘要

**總體評分**: ⭐⭐⭐⭐☆ (4/5)

**統計結果**:
- ✅ 已通過：23 / 30 項 (77%)
- ⚠️ 需補充：7 項 (23%)
- 🔴 需釐清：0 項 (0%)

**結論**: 需求規格整體品質優秀，核心架構與安全設計完整明確。建議在開始 Phase 3 實作前，補充 7 個邊界案例與容錯細節，以避免實作時產生歧義。

---

## 詳細檢查結果

### ✅ 1. 架構與整合完整性 (7/9 通過)

#### 1.1 三層架構職責劃分

- [X] **邊界檢查**: spec.md 明確定義「核心功能」與「檔案功能」的界線
  - **驗證通過**: FR-002c、FR-002e、FR-039、FR-040 清楚定義
  - **證據**: 容錯設計說明表格明確列出核心功能（資料瀏覽、履歷建立、員工管理）與檔案功能（Word、PDF、條碼）

- [X] **容錯一致性**: 所有需要桌面應用的功能在 User Stories 中標記失敗行為
  - **驗證通過**: US6、US7 包含「桌面應用不可用時」的情境
  - **證據**: FR-002e、FR-048 明確定義失敗時的使用者體驗

- [ ] **CORS 跨域範圍**: spec.md 未明確定義允許的 Origin 來源清單
  - **狀態**: ⚠️ 需補充
  - **發現**: FR-042 僅說明「允許來自 GitHub Pages 的跨域請求」，但未列出具體網域
  - **建議**: 補充以下內容到 FR-042：
    ```
    允許的 Origin 清單：
    - https://<username>.github.io (正式環境)
    - http://localhost:5173 (開發環境 - Vite)
    - http://localhost:3000 (開發環境 - React)
    ```

#### 1.2 Google API 整合

- [X] **憑證類型一致性**: 所有 Google API 使用場景正確對應憑證類型
  - **驗證通過**: Glossary 與 Credential Management 章節對應正確
  - **證據**:
    - Google Sheets 同步 → Service Account (`spreadsheets.readonly`) ✓
    - Google Drive 上傳 → OAuth 2.0 (`drive.file`) ✓

- [X] **權限範圍明確性**: 每個 API 操作定義最小權限範圍
  - **驗證通過**:
    - Service Account: `https://www.googleapis.com/auth/spreadsheets.readonly`
    - OAuth 2.0: `https://www.googleapis.com/auth/drive.file`
  - **邊界案例檢查**: Service Account 不需要 `drive.readonly`，因為所有 Drive 操作使用 OAuth（正確）

- [ ] **憑證過期處理**: spec.md 未完整定義 OAuth refresh_token 過期時的使用者流程
  - **狀態**: ⚠️ 需補充
  - **發現**: Edge Cases 提到「Google API 憑證過期：顯示明確錯誤訊息」，但未定義使用者需要執行的具體步驟
  - **建議**: 在 US6 補充 Acceptance Scenario：
    ```
    8. **Given** 使用者在 Google 帳戶撤銷授權，**When** 系統嘗試上傳檔案到 Drive，
       **Then** 顯示「授權已失效，請重新授權」並引導使用者進入授權流程
    ```

#### 1.3 部門隔離與資料流向

- [X] **部門資料隔離一致性**: 所有涉及部門的 API 端點明確說明資料過濾規則
  - **驗證通過**: FR-008（Staff 權限）涵蓋所有 CRUD 端點
  - **跨模組檢查**: US2（員工管理）、US3（權限控制）、US5（駕駛競賽）邏輯一致

- [X] **跨部門資料存取**: spec.md 定義「跨部門查詢」的所有合法場景
  - **驗證通過**: US3 的 Acceptance Scenarios 涵蓋所有角色組合
  - **邊界案例**: 主管查看「已離職」員工資料 → FR-009 涵蓋（Manager 可查看所有資料）

---

### ✅ 2. 安全與憑證管理 (5/6 通過)

#### 2.1 憑證儲存安全性

- [X] **環境變數保護**: spec.md 禁止將 Service Account JSON 儲存在程式碼或檔案系統
  - **驗證通過**: FR-059、FR-020、FR-073 明確規範
  - **證據**: Credential Management 章節使用 Base64 編碼儲存於 Render 環境變數

- [X] **加密演算法一致性**: spec.md 為所有敏感資料定義統一的加密標準
  - **驗證通過**: Glossary「Fernet 加密」+ FR-067 統一使用 Fernet
  - **跨模組檢查**: GoogleOAuthToken 資料表與本機加密檔案都使用 Fernet

- [ ] **金鑰輪替計畫**: spec.md 未定義 ENCRYPTION_KEY 的更新流程
  - **狀態**: ⚠️ 需補充
  - **發現**: SC-021 提到「憑證輪換流程可在 5 分鐘內完成」，但未說明具體步驟
  - **建議**: 在 Non-Functional Requirements 或 Maintenance 章節補充：
    ```
    金鑰輪替流程：
    1. 生成新的 ENCRYPTION_KEY
    2. 使用雙金鑰解密（舊金鑰讀取 + 新金鑰重新加密）
    3. 更新環境變數
    4. 重啟服務
    5. 驗證所有加密資料可正常解密
    ```

#### 2.2 認證與授權

- [X] **JWT Payload 完整性**: spec.md 定義 JWT Token 包含必要欄位
  - **驗證通過**: Glossary 定義包含 `user_id`, `role`, `department`
  - **改進建議**: 雖已通過，但建議補充 `exp`, `iat` 欄位定義（標準 JWT 欄位）

- [X] **角色權限矩陣**: spec.md 提供完整的「角色 × 功能」權限對照
  - **驗證通過**: FR-006 至 FR-010 涵蓋所有功能模組
  - **跨模組檢查**: US2、US3、US4、US5 都有明確權限定義

- [ ] **會話逾時行為**: spec.md 未定義 JWT Token 過期後的前端行為
  - **狀態**: ⚠️ 需補充
  - **發現**: JWT 定義中未包含 Token 有效期限與過期處理
  - **建議**: 補充以下非功能性需求：
    ```
    - **NFR-001**: JWT Token 有效期限為 24 小時
    - **NFR-002**: Token 過期時，前端必須自動重導向至登入頁面並提示「登入已逾時，請重新登入」
    - **NFR-003**: 前端可選實作 Refresh Token 機制（Silent Refresh）以改善使用者體驗
    ```

---

### ✅ 3. 資料模型與跨模組一致性 (4/6 通過)

#### 3.1 員工資料與調動記錄

- [X] **員工編號解析規則**: spec.md 定義員工編號格式與基本異常處理
  - **驗證通過**: FR-013、Glossary 定義格式 YYMMX0XXX
  - **邊界案例**: Edge Cases 提到「員工編號解析失敗：手動輸入入職年月」
  - **改進建議**: 雖已通過，但建議在 FR-013 補充異常處理流程的 UI 設計

- [X] **調動記錄權限一致性**: spec.md 定義調動前後記錄的所有權限組合
  - **驗證通過**: US2 的 Acceptance Scenarios 涵蓋所有組合
  - **證據**: Scenario 4-5 明確定義跨部門查看權限

- [X] **離職員工資料處理**: spec.md 定義離職員工的關聯資料行為
  - **驗證通過**: PC-001 明確說明「離職或不在職人員不納入排名計算」
  - **邊界案例**: 離職員工履歷可編輯性 → FR-008 涵蓋（按部門權限處理）

#### 3.2 駕駛競賽計算邏輯

- [X] **計算公式完整性**: spec.md 定義公式中所有變數的資料來源
  - **驗證通過**: PC-001 與 FR-025 至 FR-033 涵蓋所有變數
  - **證據**:
    - 每日勤務時數 → `route_standard_times` 表 ✓
    - R班係數 → Google Sheets 班表「班別」欄位 ✓
    - 責任事件數 → 暫時保留（初版不實作）✓

- [ ] **排名計算一致性**: spec.md 未定義積分相同時的排名規則
  - **狀態**: ⚠️ 需補充
  - **發現**: FR-028、US5 未說明並列排名或次要條件
  - **建議**: 在 FR-028 或 PC-001 補充：
    ```
    排名規則補充：
    - 積分相同時：並列排名（如兩人並列第 1 名，下一名為第 3 名）
    - 次要條件（可選）：積分相同時，按員工編號升序排序
    ```

- [ ] **勤務標準時間管理**: spec.md 未定義勤務時間變更後的歷史資料處理
  - **狀態**: ⚠️ 需補充
  - **發現**: FR-031 未說明以下邊界案例：
    - 勤務時間變更後，歷史資料是否重新計算？
    - 勤務標準時間刪除後，關聯的駕駛時數記錄如何處理？
    - 勤務代碼找不到對應標準時間時的行為
  - **建議**: 在 FR-031 補充：
    ```
    勤務標準時間變更規則：
    - 變更僅影響「變更日期之後」的計算，歷史資料不重新計算
    - 刪除時若有關聯記錄，改為「停用」（is_active = false）而非實體刪除
    - 找不到勤務代碼時，記錄警告日誌並將該勤務時數設為 0
    ```

---

### ✅ 4. 容錯與可靠性 (3/6 通過)

#### 4.1 桌面應用容錯

- [ ] **健康檢查頻率**: spec.md 未定義前端檢測本機 API 的輪詢策略
  - **狀態**: ⚠️ 需補充
  - **發現**: FR-002d 僅說明「啟動時檢測」，未定義運行中的輪詢策略
  - **建議**: 補充以下非功能性需求：
    ```
    - **NFR-004**: 前端在啟動時立即檢測本機 API（http://localhost:8000/health）
    - **NFR-005**: 超時時間設定為 3 秒
    - **NFR-006**: 運行中每 30 秒檢測一次（背景輪詢）
    - **NFR-007**: 連續 3 次失敗後，將本機 API 狀態標記為「不可用」
    ```

- [X] **功能降級行為**: spec.md 定義所有依賴桌面應用的功能失敗時的使用者體驗
  - **驗證通過**: FR-002e、FR-039、FR-048 與容錯設計表格涵蓋
  - **證據**: 明確定義按鈕禁用與錯誤提示訊息

#### 4.2 Google API 失敗處理

- [ ] **同步失敗重試策略**: spec.md 未定義自動同步失敗時的重試邏輯
  - **狀態**: ⚠️ 需補充
  - **發現**: Edge Cases 提到「同步任務失敗：下次同步時重試」，但未定義重試細節
  - **建議**: 補充以下定時任務規範：
    ```
    同步失敗重試策略：
    - 立即重試 1 次（間隔 30 秒）
    - 若仍失敗，等待下次定時任務（不無限重試）
    - 連續失敗 3 天後，發送郵件告警給管理員
    - 重試時使用指數退避策略（避免 API 配額耗盡）
    ```

- [X] **部分同步成功**: spec.md 定義淡海同步成功但安坑失敗時的行為
  - **驗證通過**: US4 的 Acceptance Scenarios 第 4 點
  - **證據**: 「執行安坑同步任務，使用安坑的 API 憑證與 Sheets ID」（獨立處理）

#### 4.3 資料庫與儲存

- [X] **儲存空間預警**: spec.md 定義用量達到門檻時的監控機制
  - **驗證通過**: FR-062 與「儲存空間監控」章節
  - **證據**: 達 80% (4GB) 時發送警告通知

- [X] **備份失敗處理**: spec.md 定義備份任務失敗時的日誌記錄
  - **驗證通過**: FR-050 定義「定時任務失敗必須記錄錯誤日誌並發送通知」
  - **改進建議**: 可補充 Google Drive 空間不足時的具體應變措施

---

### ✅ 5. 使用者體驗與互動流程 (3/3 通過)

#### 5.1 系統初始化

- [X] **首次啟動引導**: spec.md 定義首次啟動時的配置流程
  - **驗證通過**: US1 的 Acceptance Scenarios 涵蓋
  - **邊界案例**: Edge Cases 提到「部門設定缺失：引導管理員設定」

#### 5.2 手動同步操作

- [X] **手動同步進度顯示**: spec.md 定義進度條的更新與取消行為
  - **驗證通過**: FR-024b、FR-024c 明確定義
  - **證據**: US4 Scenario 7-8 包含進度顯示與結果統計

#### 5.3 憑證驗證即時回饋

- [X] **憑證驗證錯誤訊息**: spec.md 定義憑證驗證失敗的錯誤類型
  - **驗證通過**: FR-024d、FR-024e、FR-024f 與 US6 涵蓋
  - **證據**: US6 Scenario 7 包含具體錯誤訊息範例（如「權限不足：缺少 spreadsheets.readonly」）

---

### ✅ 6. 跨模組整合驗證 (1/2 通過)

#### 6.1 資料流向一致性

- [X] **憑證管理與同步任務**: spec.md 定義憑證變更對自動同步的影響
  - **驗證通過**: US1 與 US4 邏輯一致
  - **邊界案例**: 憑證獨立性設計（淡海與安坑獨立）避免交叉影響

- [ ] **員工調動與駕駛競賽**: spec.md 未定義調動員工的競賽排名歸屬
  - **狀態**: ⚠️ 需補充（但非阻塞項目）
  - **發現**: US2 與 US5 未明確說明月中調動員工的排名部門
  - **建議**: 在 FR-028 或 US5 補充：
    ```
    跨部門調動員工排名規則：
    - 按「當月所屬部門」計算部門排名（以月底部門為準）
    - 全公司排名不受部門影響（所有員工統一排名）
    - 調動當月的駕駛時數仍計入積分（不因調動而中斷）
    ```

#### 6.2 權限與資料可見性

- [X] **權限變更即時生效**: spec.md 的 JWT 機制支援權限變更
  - **驗證通過**: JWT Token 包含 `role` 欄位
  - **邊界案例**: Token 有效期內權限變更 → 需等待 Token 過期或重新登入（符合一般實務）

---

## 需補充項目摘要

以下 7 個項目建議在 Phase 3 實作前補充至 spec.md：

| 編號 | 類別 | 項目 | 優先級 | 建議補充位置 |
|------|------|------|--------|-------------|
| 1 | 架構 | CORS 允許的 Origin 清單 | 🟡 中 | FR-042 |
| 2 | 安全 | OAuth refresh_token 過期處理流程 | 🟡 中 | US6 或 Edge Cases |
| 3 | 安全 | ENCRYPTION_KEY 金鑰輪替計畫 | 🟢 低 | Non-Functional Requirements |
| 4 | 安全 | JWT Token 有效期限與過期行為 | 🟡 中 | Non-Functional Requirements |
| 5 | 資料模型 | 駕駛競賽積分相同時的排名規則 | 🟡 中 | FR-028 或 PC-001 |
| 6 | 資料模型 | 勤務標準時間變更後的歷史資料處理 | 🟡 中 | FR-031 |
| 7 | 容錯 | 前端健康檢查輪詢策略（頻率、超時、重試） | 🟡 中 | Non-Functional Requirements |
| 8 | 容錯 | Google API 同步失敗重試策略 | 🟡 中 | FR-050 或 Edge Cases |
| 9 | 跨模組 | 員工調動與駕駛競賽排名歸屬 | 🟢 低 | FR-028 或 US5 |

**優先級說明**:
- 🔴 高：阻塞實作，必須立即補充
- 🟡 中：可能在實作時產生歧義，建議補充
- 🟢 低：不影響實作，可延後或口頭澄清

---

## 行動建議

### 方案 A：立即補充所有項目（建議）

**優點**:
- 需求文件完整度達到 95% 以上
- 避免實作時產生歧義與返工
- 未來新成員更容易理解系統設計

**時間成本**: 約 2-3 小時

**執行步驟**:
1. 建立 `spec.md` 的補充分支或直接編輯
2. 按照上述 9 個項目逐一補充
3. 更新文件版本號與修訂歷史
4. 再次執行檢查清單驗證

---

### 方案 B：優先補充關鍵項目（快速路徑）

僅補充 🟡 中優先級項目（共 6 項），🟢 低優先級項目可在實作過程中口頭澄清。

**優點**:
- 快速進入 Phase 3 實作
- 保留彈性應對需求變化

**時間成本**: 約 1 小時

---

### 方案 C：暫不補充，實作中驗證（不建議）

直接開始 Phase 3 實作，遇到歧義時再回頭補充需求。

**缺點**:
- 可能產生返工
- 實作決策不一致風險

---

## 結論

本次檢查發現需求規格整體品質**優秀**，核心功能與安全設計非常完整。建議採用**方案 A**，投入 2-3 小時補充 9 個邊界案例與容錯細節，將需求完整度提升至 **95%** 以上，為後續實作奠定堅實基礎。

**特別優點**:
- ✅ 憑證管理策略非常完整（Credential Management 章節）
- ✅ 容錯設計清楚（三層架構職責劃分）
- ✅ 使用者故事獨立可測試（Independent Test 設計良好）
- ✅ 資料模型完整（含索引設計）

**可持續改進方向**:
- 非功能性需求可獨立成章（目前散落在各處）
- 可補充 API 端點完整清單（目前分散在各 User Story）
- 可補充前端路由設計（目前僅提及框架選擇）

---

**檢查清單版本**: v1.0
**報告生成時間**: 2026-01-28
**下次檢查建議時機**: Phase 3 完成後（US1 實作完成時）
