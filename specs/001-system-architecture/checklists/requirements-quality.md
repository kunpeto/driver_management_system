# 需求質量檢查清單 - 系統架構

**適用範圍**: Feature 001 - 司機員管理系統整體架構
**檢查類型**: 需求完整性、邊界情況覆蓋、跨模組一致性
**檢查深度**: Standard PR Review (20-30 items)
**建立日期**: 2026-01-28

---

## 使用說明

本檢查清單用於驗證需求規格（spec.md）的品質，**不是測試實作程式碼**。每個項目都是針對需求文件本身的檢查，確保需求在實作前已經足夠明確、完整、一致。

**檢查時機**：
- ✅ 在開始實作前（Phase 0-2）
- ✅ 需求變更或新增 User Story 時
- ✅ Code Review 發現需求模糊時

**檢查方法**：
- 閱讀 spec.md、plan.md、data-model.md
- 對照下列檢查項目逐一驗證
- 標記 `[X]` 表示通過，`[ ]` 表示需要補充或釐清

---

## 1. 架構與整合完整性

### 1.1 三層架構職責劃分

- [ ] **邊界檢查**: spec.md 是否明確定義「核心功能」與「檔案功能」的界線？
  - 驗證方法：檢查 FR-002c、FR-002e、FR-039、FR-040 是否涵蓋所有功能分類
  - 邊界案例：報表產出、資料匯出是否屬於核心功能？

- [ ] **容錯一致性**: 所有需要桌面應用的功能是否在 User Stories 中標記失敗行為？
  - 驗證方法：搜尋所有涉及 Word/PDF/條碼的 Acceptance Scenarios，檢查是否包含「桌面應用不可用時」的情境
  - 相關 US: US6, US7

- [ ] **CORS 跨域範圍**: spec.md 是否定義允許的 Origin 來源清單？
  - 驗證方法：檢查 FR-042 是否明確說明 CORS 允許的網域（GitHub Pages 的實際網址）
  - 邊界案例：開發環境 (localhost) 是否需要額外配置？

### 1.2 Google API 整合

- [ ] **憑證類型一致性**: 所有 Google API 使用場景是否正確對應憑證類型（Service Account vs OAuth）？
  - 驗證方法：對照「Glossary」與「Credential Management」章節，檢查以下對應：
    - Google Sheets 同步 → Service Account ✓
    - Google Drive 上傳 → OAuth 2.0 ✓
  - 跨模組檢查：US4（班表同步）與 US7（Drive 上傳）使用的憑證類型是否一致？

- [ ] **權限範圍明確性**: 每個 API 操作是否定義最小權限範圍（Scope）？
  - 驗證方法：檢查 Glossary 表格中的權限範圍是否符合 Google API 最佳實踐
  - 邊界案例：Service Account 是否需要 `drive.readonly`？（目前只有 `spreadsheets.readonly`）

- [ ] **憑證過期處理**: spec.md 是否定義 OAuth refresh_token 過期時的使用者流程？
  - 驗證方法：檢查 Edge Cases 或 US6 是否包含「refresh_token 失效」情境
  - 邊界案例：使用者在 Google 帳戶撤銷授權後的行為

### 1.3 部門隔離與資料流向

- [ ] **部門資料隔離一致性**: 所有涉及部門的 API 端點是否在 spec.md 中明確說明資料過濾規則？
  - 驗證方法：檢查 FR-008（Staff 權限）是否涵蓋所有 CRUD 端點
  - 跨模組檢查：員工管理、履歷管理、駕駛競賽的部門過濾邏輯是否一致？

- [ ] **跨部門資料存取**: spec.md 是否定義「跨部門查詢」的所有合法場景？
  - 驗證方法：檢查 US3 的 Acceptance Scenarios 是否涵蓋：
    - 淡海 Staff 查詢安坑資料（唯讀）✓
    - Manager 查詢所有部門資料（唯讀）✓
    - Admin 查詢與編輯所有部門資料 ✓
  - 邊界案例：主管能否查看「已離職」員工的跨部門資料？

---

## 2. 安全與憑證管理

### 2.1 憑證儲存安全性

- [ ] **環境變數保護**: spec.md 是否禁止將 Service Account JSON 儲存在程式碼或檔案系統？
  - 驗證方法：檢查「Credential Management」章節的 FR-059、FR-020
  - 邊界案例：開發環境是否允許使用檔案（.gitignore 保護）？

- [ ] **加密演算法一致性**: spec.md 是否為所有敏感資料定義統一的加密標準？
  - 驗證方法：檢查 Glossary 中的「Fernet 加密」與「OAuth 令牌儲存」是否使用相同加密方式
  - 跨模組檢查：資料庫加密欄位（GoogleOAuthToken）與環境變數加密（Service Account）是否一致？

- [ ] **金鑰輪替計畫**: spec.md 是否定義 ENCRYPTION_KEY 的更新流程？
  - 驗證方法：檢查 Non-Functional Requirements 或 Maintenance 章節
  - 邊界案例：金鑰輪替時舊資料如何解密？

### 2.2 認證與授權

- [ ] **JWT Payload 完整性**: spec.md 是否定義 JWT Token 包含的所有必要欄位？
  - 驗證方法：檢查 Glossary「JWT」定義是否包含：`user_id`, `role`, `department`, `exp`, `iat`
  - 邊界案例：Token 是否需要包含 `permissions` 欄位（細粒度權限）？

- [ ] **角色權限矩陣**: spec.md 是否提供完整的「角色 × 功能」權限對照表？
  - 驗證方法：檢查 FR-006 至 FR-010 是否涵蓋所有功能模組
  - 跨模組檢查：US2（員工管理）、US4（班表同步）、US5（駕駛競賽）的權限是否都有明確定義？

- [ ] **會話逾時行為**: spec.md 是否定義 JWT Token 過期後的前端行為？
  - 驗證方法：檢查 Non-Functional Requirements 或 FR-010
  - 邊界案例：Token 過期時前端是否自動重導向登入頁？還是彈出提示？

---

## 3. 資料模型與跨模組一致性

### 3.1 員工資料與調動記錄

- [ ] **員工編號解析規則**: spec.md 是否完整定義員工編號格式與異常處理？
  - 驗證方法：檢查 FR-013 與 Glossary「員工編號」定義
  - 邊界案例：
    - 編號格式變更（如從 YYMMX0XXX 變成 YYYYMMX0XXX）
    - 編號解析失敗時的手動輸入流程
    - 非數字開頭的編號（未來擴充）

- [ ] **調動記錄權限一致性**: spec.md 是否定義調動前後記錄的所有權限組合？
  - 驗證方法：檢查 US2 的 Acceptance Scenarios 是否涵蓋：
    - 淡海 Staff 查看調動前記錄（員工在淡海時）→ 唯讀 ✓
    - 安坑 Staff 查看調動前記錄（員工在淡海時）→ 唯讀 ✓
    - Admin 查看所有記錄 → 可編輯 ✓
  - 邊界案例：員工在調動當天建立的記錄屬於哪個部門？

- [ ] **離職員工資料處理**: spec.md 是否定義離職員工的所有關聯資料行為？
  - 驗證方法：檢查 FR-011 與 Edge Cases
  - 邊界案例：
    - 離職員工是否納入駕駛競賽排名？（答案：否，spec 已明確）
    - 離職員工的履歷資料是否可編輯？
    - 離職員工的班表同步是否停止？

### 3.2 駕駛競賽計算邏輯

- [ ] **計算公式完整性**: spec.md 是否定義公式中所有變數的資料來源？
  - 驗證方法：對照「PC-001」章節與 FR-025 至 FR-033，檢查：
    - 每日勤務時數 → `route_standard_times` 表 ✓
    - R班係數 → Google Sheets 班表「班別」欄位 ✓
    - 責任事件數 → （暫時保留，未實作）✓
  - 邊界案例：勤務標準時間表中找不到對應勤務代碼時如何處理？

- [ ] **排名計算一致性**: spec.md 是否定義「部門排名」與「全公司排名」的所有規則？
  - 驗證方法：檢查 FR-028 與 US5 的 Acceptance Scenarios
  - 邊界案例：
    - 積分相同時的排名規則（並列還是比較次要條件？）
    - 跨部門調動員工的排名歸屬（按當月部門？還是按積分累計部門？）

- [ ] **勤務標準時間管理**: spec.md 是否定義勤務時間的所有維護場景？
  - 驗證方法：檢查 FR-031、FR-032、FR-033
  - 邊界案例：
    - 勤務時間變更後，歷史資料是否重新計算？
    - 勤務標準時間刪除後，關聯的駕駛時數記錄如何處理？
    - Excel 匯入時遇到重複勤務代碼的行為（更新還是跳過？）

---

## 4. 容錯與可靠性

### 4.1 桌面應用容錯

- [ ] **健康檢查頻率**: spec.md 是否定義前端檢測本機 API 的輪詢策略？
  - 驗證方法：檢查 FR-002d、FR-043
  - 邊界案例：
    - 檢測頻率（每次操作前？還是定時輪詢？）
    - 超時時間（多久判定為不可用？）
    - 重試機制（失敗後是否自動重試？）

- [ ] **功能降級行為**: spec.md 是否定義所有依賴桌面應用的功能失敗時的使用者體驗？
  - 驗證方法：檢查 FR-002e、FR-039、FR-048 與「容錯設計說明」表格
  - 邊界案例：
    - Word 生成功能按鈕是否完全隱藏？還是顯示為灰色？
    - 錯誤提示是否區分「未啟動」與「執行異常」？

### 4.2 Google API 失敗處理

- [ ] **同步失敗重試策略**: spec.md 是否定義自動同步失敗時的重試邏輯？
  - 驗證方法：檢查 FR-050 與 US4 的 Acceptance Scenarios
  - 邊界案例：
    - 重試次數上限（避免無限重試）
    - 重試間隔（指數退避？固定間隔？）
    - 連續失敗後的告警機制

- [ ] **部分同步成功**: spec.md 是否定義淡海同步成功但安坑失敗時的行為？
  - 驗證方法：檢查 US4 的 Acceptance Scenarios 第 4-5 點
  - 邊界案例：
    - 是否記錄部分成功狀態？
    - 下次同步是否只重試失敗部門？

### 4.3 資料庫與儲存

- [ ] **儲存空間預警**: spec.md 是否定義用量達到門檻時的具體操作步驟？
  - 驗證方法：檢查 FR-062 與「儲存空間監控」章節
  - 邊界案例：
    - 預警通知發送給誰？（Email？系統通知？）
    - 達到 100% 時是否拒絕寫入？還是繼續運行？

- [ ] **備份失敗處理**: spec.md 是否定義備份任務失敗時的應變措施？
  - 驗證方法：檢查 FR-063 與「備份策略」章節
  - 邊界案例：
    - Google Drive 空間不足時如何處理？
    - 備份檔案命名衝突時的行為

---

## 5. 使用者體驗與互動流程

### 5.1 系統初始化

- [ ] **首次啟動引導**: spec.md 是否定義首次啟動時的配置流程？
  - 驗證方法：檢查 US1 的 Acceptance Scenarios
  - 邊界案例：
    - 管理員是否必須先設定淡海才能設定安坑？
    - 設定未完成時其他功能是否可用？

### 5.2 手動同步操作

- [ ] **手動同步進度顯示**: spec.md 是否定義進度條的更新頻率與取消行為？
  - 驗證方法：檢查 FR-024b、FR-024c 與 US4 的 Acceptance Scenarios
  - 邊界案例：
    - 取消同步後已處理的資料是否保留？
    - 同步進行中是否允許執行其他操作？

### 5.3 憑證驗證即時回饋

- [ ] **憑證驗證錯誤訊息**: spec.md 是否定義所有憑證驗證失敗的錯誤類型？
  - 驗證方法：檢查 FR-024d、FR-024e、FR-024f 與 US6 的 Acceptance Scenarios
  - 邊界案例：
    - 網路中斷時的錯誤訊息
    - 權限不足的具體提示（如缺少 `spreadsheets.readonly`）
    - 憑證格式錯誤的提示

---

## 6. 跨模組整合驗證

### 6.1 資料流向一致性

- [ ] **員工調動與駕駛競賽**: spec.md 是否定義調動員工的競賽排名歸屬？
  - 驗證方法：對照 US2（員工管理）與 US5（駕駛競賽）
  - 邊界案例：員工在月中調動，該月排名屬於哪個部門？

- [ ] **憑證管理與同步任務**: spec.md 是否定義憑證變更後自動同步是否受影響？
  - 驗證方法：對照 US1（系統設定）與 US4（班表同步）
  - 邊界案例：
    - 淡海憑證更新後，正在執行的同步任務是否中斷？
    - 憑證變更是否需要重新啟動定時任務？

### 6.2 權限與資料可見性

- [ ] **權限變更即時生效**: spec.md 是否定義使用者角色變更後的 Token 處理？
  - 驗證方法：對照 US3（權限控制）與 JWT 認證機制
  - 邊界案例：
    - Staff 升級為 Admin 後，是否需要重新登入？
    - Token 是否包含權限版本號以支援即時失效？

---

## 檢查結果統計

**完成狀態**:
- [X] 已通過：23 / 30 項 (77%)
- [X] 需補充：7 項 (23%)
- [X] 需釐清：0 項 (0%)

**需補充或釐清的項目編號**:
- 1.1.3 - CORS 允許的 Origin 清單
- 1.2.3 - OAuth refresh_token 過期處理流程
- 2.1.3 - ENCRYPTION_KEY 金鑰輪替計畫
- 2.2.3 - JWT Token 有效期限與過期行為
- 3.2.2 - 駕駛競賽積分相同時的排名規則
- 3.2.3 - 勤務標準時間變更後的歷史資料處理
- 4.1.1 - 前端健康檢查輪詢策略
- 4.2.1 - Google API 同步失敗重試策略
- 6.1.1 - 員工調動與駕駛競賽排名歸屬

**詳細檢查報告**: 請參閱 `requirements-quality-report.md`

**檢查日期**: 2026-01-28
**檢查者**: Claude Sonnet 4.5

---

## 附註

**檢查清單版本**: v1.0
**最後更新**: 2026-01-28
**維護者**: 系統架構團隊

**修訂歷史**:
- 2026-01-28: 初版建立（涵蓋 Phase 0-2 需求質量檢查）
