# 司機員管理系統 Constitution

## Core Principles

### I. 雙部門架構原則
系統必須完整支援新北捷運輕軌營運處車務中心的雙部門架構（淡海分處、安坑分處）。
- 每個部門擁有獨立的 Google 服務配置（Sheets、Drive、API 憑證）
- 資料庫共享，但介面根據使用者部門進行過濾與權限控制
- 部門資訊硬編碼為「淡海」與「安坑」，不提供新增/刪除部門功能

### II. 權限分離原則 (NON-NEGOTIABLE)
系統必須嚴格區分三種角色的權限：
- **Admin（系統管理人員）**：全部功能與後台參數管理
- **Staff（值班台人員）**：本部門資料 CRUD + 他部門資料唯讀
- **Manager（主管）**：所有部門資料唯讀 + 報表產出

員工調動後的權限規則：
- 調動前的記錄：原部門人員唯讀，新部門人員唯讀
- 調動後的記錄：新部門人員可編輯

### III. 資料來源多樣性
系統整合多種資料來源，每個來源必須獨立配置：
- **Google Sheets 班表**：每日自動同步，唯讀權限
- **Google Sheets 勤務表**：駕駛時數資料來源，每日自動同步
- **Google Drive**：PDF 文件儲存，按部門分資料夾
- **TiDB MySQL**：雲端共享資料庫，即時同步

### IV. 混合架構原則（2026-01-28 修訂）
系統採用三層混合架構，確保核心功能獨立運作：
- **前端網頁應用（GitHub Pages）**：主要使用者介面，提供所有核心功能（資料瀏覽、編輯、報表查詢）
- **雲端後端 API（Render FastAPI）**：履歷管理、考核系統、報表產出、資料同步、使用者認證
- **本機桌面應用 API（FastAPI localhost）**：檔案處理功能（PDF 條碼識別、Word 生成、Google Drive 上傳）
- **容錯設計**：核心功能完全運行於網頁端，本機應用不可用時給予提示但不影響主要業務流程

**架構變更理由**（相較於原 PyQt6 桌面應用方案）：
1. **跨平台性**：網頁應用支援 Windows/macOS/Linux，無需各平台分別打包
2. **維護性**：前後端分離，可獨立部署與更新
3. **使用性**：無需安裝，開啟瀏覽器即可使用
4. **可靠性**：核心功能獨立於本機應用，降低單點故障風險

### V. 歷史資料完整性
員工調動或離職不刪除歷史記錄：
- 員工調動：記錄完整的調動歷史，保留所有部門時期的資料
- 員工離職：標記為已離職，不刪除任何關聯記錄
- 考核記錄：與員工軟關聯，員工離職不影響考核統計

### VI. 自動化優先
減少手動操作，提升資料準確性：
- 班表與勤務表每日自動同步（凌晨 2:00-3:00）
- 駕駛競賽排名每月自動計算
- 入職年月從員工編號自動解析
- 考核累計次數自動計算與加重

## 技術約束

### 雲端服務限制
- **Render 免費版**：512MB RAM 限制，不處理 PDF（本機處理）
- **TiDB 免費版**：5GB 儲存空間，需定期監控用量
- **UptimeRobot**：保持 Render 服務 24/7 喚醒（750 小時/月額度足夠）

### Google API 限制
- 每個部門使用獨立的服務帳戶（Service Account）
- 僅使用唯讀權限（Sheets）或寫入權限（Drive）
- **憑證安全儲存策略**：
  - **服務帳戶憑證**：Base64 編碼後儲存於 Render 環境變數（`{部門}_GOOGLE_SERVICE_ACCOUNT_JSON`）
  - **OAuth 令牌**（雲端）：Fernet 加密後儲存於 TiDB 資料庫（`google_oauth_tokens` 表）
  - **OAuth 令牌**（本機）：加密檔案 `~/.driver_management_system/tokens.encrypted`（權限 0o600）
  - **加密金鑰**：環境變數 `ENCRYPTION_KEY`（Fernet 格式）
- 所有憑證相關檔案必須加入 `.gitignore`，禁止上傳版本控制

### 資料庫遷移
- 從 SQLite（前專案）遷移至 TiDB MySQL
- 保留前專案所有資料模型，擴充部門與調動欄位
- 使用 SQLAlchemy ORM，方言差異需處理（AUTOINCREMENT → AUTO_INCREMENT）

## 開發流程

### 規格先行
所有功能必須先撰寫規格文件（spec.md），包含：
- User Stories with Independent Tests
- Functional Requirements (FR-XXX)
- Success Criteria (SC-XXX)
- Edge Cases

### 待釐清事項追蹤
規格文件必須明確標記待釐清事項（Pending Clarifications），包含：
- 問題描述
- 影響範圍
- 預計釐清時間
- 備選方案（如有）

### 測試要求
- 單元測試：業務邏輯函數必須測試
- 整合測試：Google API 連接、資料庫操作必須測試
- 權限測試：三種角色的權限邊界必須測試

## 資料安全

### 敏感資訊保護
- **Google API 憑證**：
  - 服務帳戶：Render 環境變數（Base64 編碼）
  - OAuth 令牌：Fernet 對稱加密後儲存（資料庫或本機加密檔案）
  - 絕不明文儲存、不寫入日誌、不提交版本控制
- **資料庫憑證**：環境變數配置（`.env`），`.env` 檔案加入 `.gitignore`
- **使用者密碼**：bcrypt 加密儲存（最低成本因子：12）
- **加密金鑰管理**：
  - 使用 `cryptography.fernet` 產生 44 字元 Base64 金鑰
  - 金鑰儲存於環境變數 `ENCRYPTION_KEY`
  - 定期輪換（建議每 90 天）

### 資料備份
- TiDB 自動備份（雲端供應商）
- 關鍵操作記錄日誌（audit_log 表）
- 資料匯出功能（Excel）供本機備份

## Governance

本憲章為系統設計的最高原則，所有功能實作必須遵守：
- 違反憲章的設計需經使用者批准並記錄例外原因
- 憲章修訂需更新版本號並記錄修訂日期
- 新增原則需說明理由與影響範圍

**Version**: 1.2.0 | **Ratified**: 2026-01-28 | **Last Amended**: 2026-01-28

---

## Revision History

### v1.2.0 (2026-01-28)
**修訂章節**: 技術約束 - Google API 限制、資料安全 - 敏感資訊保護

**變更內容**:
- 移除舊的憑證檔案路徑描述（`config/credentials_{部門}.json`）
- 新增完整的憑證安全儲存策略：
  - 服務帳戶憑證：Render 環境變數（Base64）
  - OAuth 令牌：資料庫加密欄位 + 本機加密檔案
  - 加密金鑰：環境變數 `ENCRYPTION_KEY`
- 補充憑證保護最佳實踐（不明文儲存、不寫入日誌、定期輪換）
- 新增資料庫 `google_oauth_tokens` 表設計規範

**變更理由**:
1. **安全性提升**：檔案系統儲存憑證易遭竊取，環境變數 + 加密儲存更安全
2. **部署便利性**：Render 平台原生支援環境變數，無需檔案管理
3. **多環境一致性**：開發/測試/生產環境使用相同的憑證管理機制
4. **OAuth 支援**：新增 OAuth 2.0 使用者授權流程（Google Drive 上傳）

**影響範圍**:
- 環境變數配置：新增 `TANHAE_GOOGLE_SERVICE_ACCOUNT_JSON`、`ANPING_GOOGLE_SERVICE_ACCOUNT_JSON`、`ENCRYPTION_KEY`
- 資料模型：新增 `GoogleOAuthToken` 表（`encrypted_refresh_token`、`encrypted_access_token` 欄位）
- 工具類別：新增 `TokenEncryption` 類別（Fernet 加密/解密）
- `.gitignore` 規則：確保 `.env` 與所有憑證檔案被排除

**批准**: 與 spec.md v1.4（憑證管理章節）保持一致

---

### v1.1.0 (2026-01-28)
**修訂原則**: IV. 混合架構原則

**變更內容**:
- 架構從「PyQt6 桌面應用 + 雲端 API」改為「GitHub Pages 網頁應用 + 雲端 API + 本機 API」
- 移除「雙模式顯示（QWebEngineView / Chrome）」描述
- 新增「容錯設計：核心功能獨立於本機應用」原則
- 明確定義三層架構的職責劃分

**變更理由**:
1. 提升跨平台性：網頁應用支援所有主流作業系統與瀏覽器
2. 降低部署複雜度：無需各平台分別打包桌面應用
3. 提升可維護性：前後端分離，可獨立開發與部署
4. 增強可靠性：核心功能不依賴本機應用，降低單點故障風險

**影響範圍**:
- 前端技術棧：Vue.js 3 (取代 PyQt6)
- 部署方式：GitHub Pages (取代桌面應用安裝包)
- 本機應用角色：從「主要介面」降級為「輔助功能」（檔案處理）

**批准**: 由使用者於 Phase 0 研究階段確認

---

### v1.0.0 (2026-01-28)
**初始版本**: 建立憲章，定義六大核心原則與技術約束
